<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Elua-svn] r356 - in trunk/src/platform/stm32: . FWLib
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/elua-svn/2009-July/index.html" >
   <LINK REL="made" HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r356%20-%20in%20trunk/src/platform/stm32%3A%20.%20FWLib&In-Reply-To=%3C200907082340.n68Ne2nu021266%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000310.html">
   <LINK REL="Next"  HREF="000312.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Elua-svn] r356 - in trunk/src/platform/stm32: . FWLib</H1>
    <B>jbsnyder at BerliOS</B> 
    <A HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r356%20-%20in%20trunk/src/platform/stm32%3A%20.%20FWLib&In-Reply-To=%3C200907082340.n68Ne2nu021266%40sheep.berlios.de%3E"
       TITLE="[Elua-svn] r356 - in trunk/src/platform/stm32: . FWLib">jbsnyder at mail.berlios.de
       </A><BR>
    <I>Thu Jul  9 01:40:02 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000310.html">[Elua-svn] r355 - trunk/src/platform/stm32/FWLib/library/src
</A></li>
        <LI>Next message: <A HREF="000312.html">[Elua-svn] r357 - in trunk: . romfs src/platform/stm32
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#311">[ date ]</a>
              <a href="thread.html#311">[ thread ]</a>
              <a href="subject.html#311">[ subject ]</a>
              <a href="author.html#311">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jbsnyder
Date: 2009-07-09 01:40:01 +0200 (Thu, 09 Jul 2009)
New Revision: 356

Removed:
   trunk/src/platform/stm32/FWLib/stm32f10x_conf.h
Modified:
   trunk/src/platform/stm32/platform.c
Log:
Further PWM experiments.

Deleted: trunk/src/platform/stm32/FWLib/stm32f10x_conf.h
===================================================================
--- trunk/src/platform/stm32/FWLib/stm32f10x_conf.h	2009-07-08 23:39:53 UTC (rev 355)
+++ trunk/src/platform/stm32/FWLib/stm32f10x_conf.h	2009-07-08 23:40:01 UTC (rev 356)
@@ -1,174 +0,0 @@
-/******************** (C) COPYRIGHT 2008 STMicroelectronics ********************
-* File Name          : stm32f10x_conf.h
-* Author             : MCD Application Team
-* Version            : V2.0.3
-* Date               : 09/22/2008
-* Description        : Library configuration file.
-********************************************************************************
-* THE PRESENT FIRMWARE WHICH IS FOR GUIDANCE ONLY AIMS AT PROVIDING CUSTOMERS
-* WITH CODING INFORMATION REGARDING THEIR PRODUCTS IN ORDER FOR THEM TO SAVE TIME.
-* AS A RESULT, STMICROELECTRONICS SHALL NOT BE HELD LIABLE FOR ANY DIRECT,
-* INDIRECT OR CONSEQUENTIAL DAMAGES WITH RESPECT TO ANY CLAIMS ARISING FROM THE
-* CONTENT OF SUCH FIRMWARE AND/OR THE USE MADE BY CUSTOMERS OF THE CODING
-* INFORMATION CONTAINED HEREIN IN CONNECTION WITH THEIR PRODUCTS.
-*******************************************************************************/
-
-/* Define to prevent recursive inclusion -------------------------------------*/
-#ifndef __STM32F10x_CONF_H
-#define __STM32F10x_CONF_H
-
-/* Includes ------------------------------------------------------------------*/
-#include &quot;stm32f10x_type.h&quot;
-
-/* Exported types ------------------------------------------------------------*/
-/* Exported constants --------------------------------------------------------*/
-/* Uncomment the line below to compile the library in DEBUG mode, this will expanse
-   the &quot;assert_param&quot; macro in the firmware library code (see &quot;Exported macro&quot;
-   section below) */
-/* #define DEBUG    1*/
-
-/* Comment the line below to disable the specific peripheral inclusion */
-/************************************* ADC ************************************/
-#define _ADC
-#define _ADC1
-#define _ADC2
-#define _ADC3
-
-/************************************* BKP ************************************/
-#define _BKP 
-
-/************************************* CAN ************************************/
-#define _CAN
-
-/************************************* CRC ************************************/
-#define _CRC
-
-/************************************* DAC ************************************/
-#define _DAC
-
-/************************************* DBGMCU *********************************/
-#define _DBGMCU
-
-/************************************* DMA ************************************/
-#define _DMA
-#define _DMA1_Channel1
-#define _DMA1_Channel2
-#define _DMA1_Channel3
-#define _DMA1_Channel4
-#define _DMA1_Channel5
-#define _DMA1_Channel6
-#define _DMA1_Channel7
-#define _DMA2_Channel1
-#define _DMA2_Channel2
-#define _DMA2_Channel3
-#define _DMA2_Channel4
-#define _DMA2_Channel5
-
-/************************************* EXTI ***********************************/
-#define _EXTI
-
-/************************************* FLASH and Option Bytes *****************/
-#define _FLASH
-/* Uncomment the line below to enable FLASH program/erase/protections functions,
-   otherwise only FLASH configuration (latency, prefetch, half cycle) functions
-   are enabled */
-/* #define _FLASH_PROG */
-
-/************************************* FSMC ***********************************/
-#define _FSMC
-
-/************************************* GPIO ***********************************/
-#define _GPIO
-#define _GPIOA
-#define _GPIOB
-#define _GPIOC
-#define _GPIOD
-#define _GPIOE
-#define _GPIOF
-#define _GPIOG
-#define _AFIO
-
-/************************************* I2C ************************************/
-#define _I2C
-#define _I2C1
-#define _I2C2
-
-/************************************* IWDG ***********************************/
-#define _IWDG
-
-/************************************* NVIC ***********************************/
-#define _NVIC
-
-/************************************* PWR ************************************/
-#define _PWR
-
-/************************************* RCC ************************************/
-#define _RCC
-
-/************************************* RTC ************************************/
-#define _RTC
-
-/************************************* SDIO ***********************************/
-#define _SDIO
-
-/************************************* SPI ************************************/
-#define _SPI
-#define _SPI1
-#define _SPI2
-#define _SPI3
-
-/************************************* SysTick ********************************/
-#define _SysTick
-
-/************************************* TIM ************************************/
-#define _TIM
-#define _TIM1
-#define _TIM2
-#define _TIM3
-#define _TIM4
-#define _TIM5
-#define _TIM6
-#define _TIM7
-#define _TIM8
-
-/************************************* USART **********************************/
-#define _USART
-#define _USART1
-#define _USART2
-#define _USART3
-#define _UART4
-#define _UART5
-
-/************************************* WWDG ***********************************/
-#define _WWDG
-
-/* In the following line adjust the value of External High Speed oscillator (HSE)
-   used in your application */
-#define HSE_Value    ((u32)8000000) /* Value of the External oscillator in Hz*/
-
-/* In the following line adjust the External High Speed oscillator (HSE) Startup 
-   Timeout value */
-#define HSEStartUp_TimeOut    ((u16)0x0500) /* Time out for HSE start up */
-
-/* Exported macro ------------------------------------------------------------*/
-#ifdef  DEBUG
-/*******************************************************************************
-* Macro Name     : assert_param
-* Description    : The assert_param macro is used for function's parameters check.
-*                  It is used only if the library is compiled in DEBUG mode. 
-* Input          : - expr: If expr is false, it calls assert_failed function
-*                    which reports the name of the source file and the source
-*                    line number of the call that failed. 
-*                    If expr is true, it returns no value.
-* Return         : None
-*******************************************************************************/ 
-  #define assert_param(expr) ((expr) ? (void)0 : assert_failed((u8 *)__FILE__, __LINE__))
-/* Exported functions ------------------------------------------------------- */
-  void assert_failed(u8* file, u32 line);
-#else
-  #define assert_param(expr) ((void)0)
-#endif /* DEBUG */
-
-#endif /* __STM32F10x_CONF_H */
-
-/******************* (C) COPYRIGHT 2008 STMicroelectronics *****END OF FILE****/

Modified: trunk/src/platform/stm32/platform.c
===================================================================
--- trunk/src/platform/stm32/platform.c	2009-07-08 23:39:53 UTC (rev 355)
+++ trunk/src/platform/stm32/platform.c	2009-07-08 23:40:01 UTC (rev 356)
@@ -95,8 +95,10 @@
 static void RCC_Configuration(void)
 {
   SystemInit();
+  
+  RCC_PCLK1Config(RCC_HCLK_Div2);
 
-  RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);
+  //RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);
 }
 
 // ****************************************************************************
@@ -688,10 +690,10 @@
   RCC_APB1PeriphClockCmd( RCC_APB1Periph_TIM3, ENABLE );
   RCC_APB1PeriphClockCmd( RCC_APB1Periph_TIM4, ENABLE );
   RCC_APB1PeriphClockCmd( RCC_APB1Periph_TIM5, ENABLE );
-  RCC_APB2PeriphClockCmd( RCC_APB2Periph_TIM8, ENABLE );  
 
+
   // Configure timers
-  for( i = 0; i &lt; NUM_TIMER; i ++ )
+  for( i = 0; i &lt; NUM_TIMER - 1; i ++ )
   {
     TIM_TimeBaseStructure.TIM_Period = 0xFFFF;
     TIM_TimeBaseStructure.TIM_Prescaler = TIM_GET_BASE_CLK( i ) / TIM_STARTUP_CLOCK;
@@ -789,6 +791,7 @@
 
 static void pwms_init()
 {
+  RCC_APB2PeriphClockCmd( RCC_APB2Periph_TIM8, ENABLE );  
   // 
 }
 
@@ -810,7 +813,7 @@
   TIM_TimeBaseStructure.TIM_Period = 999;  //(TIM_GET_BASE_CLK( PWM_TIMER_ID ) / clock) - 1;
   TIM_TimeBaseStructure.TIM_Prescaler = 0;
   TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1;
-  TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Down;
+  TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;
   TIM_TimeBaseStructure.TIM_RepetitionCounter = 0x0000;
   TIM_TimeBaseInit( ptimer, &amp;TIM_TimeBaseStructure );
     
@@ -821,18 +824,17 @@
 {
   TIM_OCInitTypeDef  TIM_OCInitStructure;
   TIM_TypeDef* ptimer = timer[ PWM_TIMER_ID ];
-  TIM_BDTRInitTypeDef TIM_BDTRInitStructure;
   u32 clock;
   
   TIM_Cmd(ptimer, DISABLE);
+  TIM_SetCounter( ptimer, 0 );
   
-  clock = platform_pwm_set_clock( frequency );
-  
-  TIM_Cmd( ptimer, ENABLE );
-  
   // Set up PIO for output
   platform_pio_op( 2, pwm_gpio_pins[ id ], PLATFORM_IO_PIN_DIR_OUTPUT );
   
+  clock = platform_pwm_set_clock( frequency );
+  TIM_ARRPreloadConfig( ptimer, ENABLE );
+  
   /* PWM Mode configuration */  
   TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1;
   TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;
@@ -846,34 +848,28 @@
     case 0:
       TIM_OC1Init( ptimer, &amp;TIM_OCInitStructure );
       TIM_OC1PreloadConfig( ptimer, TIM_OCPreload_Enable );
-      clock = 0;
       break;
     case 1:
       TIM_OC2Init( ptimer, &amp;TIM_OCInitStructure );
       TIM_OC2PreloadConfig( ptimer, TIM_OCPreload_Enable );
-      clock = 1;
       break;
     case 2:
       TIM_OC3Init( ptimer, &amp;TIM_OCInitStructure );
       TIM_OC3PreloadConfig( ptimer, TIM_OCPreload_Enable );
-      clock = 2;
       break;
     case 3:
       TIM_OC4Init( ptimer, &amp;TIM_OCInitStructure );
       TIM_OC4PreloadConfig( ptimer, TIM_OCPreload_Enable ) ;
-      clock = 3;
       break;
     default:
-      return 4;
+      return 0;
   }
     
-  TIM_ARRPreloadConfig( ptimer, ENABLE );
 
-  TIM_SelectOCxM( ptimer, TIM_Channel_1, TIM_OCMode_PWM1 );
-
   TIM_CtrlPWMOutputs(ptimer, ENABLE);  
-  ptimer-&gt;EGR |= TIM_EventSource_Update;
-      
+  
+  TIM_Cmd( ptimer, ENABLE );
+  
   return clock;
 }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000310.html">[Elua-svn] r355 - trunk/src/platform/stm32/FWLib/library/src
</A></li>
	<LI>Next message: <A HREF="000312.html">[Elua-svn] r357 - in trunk: . romfs src/platform/stm32
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#311">[ date ]</a>
              <a href="thread.html#311">[ thread ]</a>
              <a href="subject.html#311">[ subject ]</a>
              <a href="author.html#311">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/elua-svn">More information about the eLua-svn
mailing list</a><br>
</body></html>
