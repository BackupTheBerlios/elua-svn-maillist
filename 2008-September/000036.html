<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Elua-svn] r80 - in trunk: . src src/lua src/lualong src/newlib
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/elua-svn/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r80%20-%20in%20trunk%3A%20.%20src%20src/lua%20src/lualong%20src/newlib&In-Reply-To=%3C200809101757.m8AHvSrq009595%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000035.html">
   <LINK REL="Next"  HREF="000037.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Elua-svn] r80 - in trunk: . src src/lua src/lualong src/newlib</H1>
    <B>bogdanm at BerliOS</B> 
    <A HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r80%20-%20in%20trunk%3A%20.%20src%20src/lua%20src/lualong%20src/newlib&In-Reply-To=%3C200809101757.m8AHvSrq009595%40sheep.berlios.de%3E"
       TITLE="[Elua-svn] r80 - in trunk: . src src/lua src/lualong src/newlib">bogdanm at mail.berlios.de
       </A><BR>
    <I>Wed Sep 10 19:57:28 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000035.html">[Elua-svn] r79 - tags
</A></li>
        <LI>Next message: <A HREF="000037.html">[Elua-svn] r81 - trunk/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36">[ date ]</a>
              <a href="thread.html#36">[ thread ]</a>
              <a href="subject.html#36">[ subject ]</a>
              <a href="author.html#36">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: bogdanm
Date: 2008-09-10 19:57:24 +0200 (Wed, 10 Sep 2008)
New Revision: 80

Modified:
   trunk/SConstruct
   trunk/src/lua/Makefile
   trunk/src/lua/lapi.c
   trunk/src/lua/lapi.h
   trunk/src/lua/lauxlib.c
   trunk/src/lua/lauxlib.h
   trunk/src/lua/lbaselib.c
   trunk/src/lua/lcode.c
   trunk/src/lua/lcode.h
   trunk/src/lua/ldblib.c
   trunk/src/lua/ldebug.c
   trunk/src/lua/ldebug.h
   trunk/src/lua/ldo.c
   trunk/src/lua/ldo.h
   trunk/src/lua/ldump.c
   trunk/src/lua/lfunc.c
   trunk/src/lua/lfunc.h
   trunk/src/lua/lgc.c
   trunk/src/lua/lgc.h
   trunk/src/lua/linit.c
   trunk/src/lua/liolib.c
   trunk/src/lua/llex.c
   trunk/src/lua/llex.h
   trunk/src/lua/llimits.h
   trunk/src/lua/lmathlib.c
   trunk/src/lua/lmem.c
   trunk/src/lua/lmem.h
   trunk/src/lua/loadlib.c
   trunk/src/lua/lobject.c
   trunk/src/lua/lobject.h
   trunk/src/lua/lopcodes.c
   trunk/src/lua/lopcodes.h
   trunk/src/lua/loslib.c
   trunk/src/lua/lparser.c
   trunk/src/lua/lparser.h
   trunk/src/lua/lstate.c
   trunk/src/lua/lstate.h
   trunk/src/lua/lstring.c
   trunk/src/lua/lstring.h
   trunk/src/lua/lstrlib.c
   trunk/src/lua/ltable.c
   trunk/src/lua/ltable.h
   trunk/src/lua/ltablib.c
   trunk/src/lua/ltm.c
   trunk/src/lua/ltm.h
   trunk/src/lua/lua.c
   trunk/src/lua/lua.h
   trunk/src/lua/luac.c
   trunk/src/lua/luaconf.h
   trunk/src/lua/lualib.h
   trunk/src/lua/lundump.c
   trunk/src/lua/lundump.h
   trunk/src/lua/lvm.c
   trunk/src/lua/lvm.h
   trunk/src/lua/lzio.c
   trunk/src/lua/lzio.h
   trunk/src/lua/print.c
   trunk/src/lualong/lapi.c
   trunk/src/lualong/lapi.h
   trunk/src/lualong/lauxlib.c
   trunk/src/lualong/lauxlib.h
   trunk/src/lualong/lbaselib.c
   trunk/src/lualong/lcode.c
   trunk/src/lualong/lcode.h
   trunk/src/lualong/ldblib.c
   trunk/src/lualong/ldebug.c
   trunk/src/lualong/ldebug.h
   trunk/src/lualong/ldo.c
   trunk/src/lualong/ldo.h
   trunk/src/lualong/ldump.c
   trunk/src/lualong/lfunc.c
   trunk/src/lualong/lfunc.h
   trunk/src/lualong/lgc.c
   trunk/src/lualong/lgc.h
   trunk/src/lualong/linit.c
   trunk/src/lualong/liolib.c
   trunk/src/lualong/llex.c
   trunk/src/lualong/llex.h
   trunk/src/lualong/llimits.h
   trunk/src/lualong/lmathlib.c
   trunk/src/lualong/lmem.c
   trunk/src/lualong/lmem.h
   trunk/src/lualong/loadlib.c
   trunk/src/lualong/lobject.c
   trunk/src/lualong/lobject.h
   trunk/src/lualong/lopcodes.c
   trunk/src/lualong/lopcodes.h
   trunk/src/lualong/loslib.c
   trunk/src/lualong/lparser.c
   trunk/src/lualong/lparser.h
   trunk/src/lualong/lstate.c
   trunk/src/lualong/lstate.h
   trunk/src/lualong/lstring.c
   trunk/src/lualong/lstring.h
   trunk/src/lualong/lstrlib.c
   trunk/src/lualong/ltable.c
   trunk/src/lualong/ltable.h
   trunk/src/lualong/ltablib.c
   trunk/src/lualong/ltm.c
   trunk/src/lualong/ltm.h
   trunk/src/lualong/lua.c
   trunk/src/lualong/lua.h
   trunk/src/lualong/luac.c
   trunk/src/lualong/luaconf.h
   trunk/src/lualong/lualib.h
   trunk/src/lualong/lundump.c
   trunk/src/lualong/lundump.h
   trunk/src/lualong/lvm.c
   trunk/src/lualong/lvm.h
   trunk/src/lualong/lzio.c
   trunk/src/lualong/lzio.h
   trunk/src/lualong/print.c
   trunk/src/main.c
   trunk/src/newlib/stubs.c
Log:
updated to Lua 5.1.4

Modified: trunk/SConstruct
===================================================================
--- trunk/SConstruct	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/SConstruct	2008-09-10 17:57:24 UTC (rev 80)
@@ -102,13 +102,11 @@
 lua_files = &quot;&quot;&quot;lapi.c lcode.c ldebug.c ldo.c ldump.c lfunc.c lgc.c llex.c lmem.c lobject.c lopcodes.c
    lparser.c lstate.c lstring.c ltable.c ltm.c lundump.c lvm.c lzio.c lauxlib.c lbaselib.c
    ldblib.c liolib.c lmathlib.c loslib.c ltablib.c lstrlib.c loadlib.c linit.c lua.c&quot;&quot;&quot;
-if target == 'lualong':
+if target == 'lualong' or target == 'lua':
   lua_full_files = &quot; &quot; + &quot; &quot;.join( [ &quot;src/lualong/%s&quot; % name for name in lua_files.split() ] )
   local_include = &quot;-Iinc -Iinc/newlib -Isrc/lualong&quot;  
-  cdefs = cdefs + ' -DLUA_INTONLY'
-elif target == 'lua':
-  lua_full_files = &quot; &quot; + &quot; &quot;.join( [ &quot;src/lua/%s&quot; % name for name in lua_files.split() ] )   
-  local_include = &quot;-Iinc -Iinc/newlib -Isrc/lua&quot;   
+  if target == 'lualong':
+    cdefs = cdefs + ' -DLUA_NUMBER_INTEGRAL'
 else:
   print &quot;Invalid target&quot;, target
   sys.exit( 1 )

Modified: trunk/src/lua/Makefile
===================================================================
--- trunk/src/lua/Makefile	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/Makefile	2008-09-10 17:57:24 UTC (rev 80)
@@ -7,10 +7,10 @@
 # Your platform. See PLATS for possible values.
 PLAT= none
 
-CC= arm-elf-gcc -O2 -Os
+CC= gcc
 CFLAGS= -O2 -Wall $(MYCFLAGS)
-AR= arm-elf-ar rcu
-RANLIB= arm-elf-ranlib
+AR= ar rcu
+RANLIB= ranlib
 RM= rm -f
 LIBS= -lm $(MYLIBS)
 

Modified: trunk/src/lua/lapi.c
===================================================================
--- trunk/src/lua/lapi.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lapi.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lapi.c,v 1.1.1.1 2008/07/11 13:12:14 bogdanm Exp $
+** $Id: lapi.c,v 2.55.1.5 2008/07/04 18:41:18 roberto Exp $
 ** Lua API
 ** See Copyright Notice in lua.h
 */
@@ -93,15 +93,14 @@
 
 
 LUA_API int lua_checkstack (lua_State *L, int size) {
-  int res;
+  int res = 1;
   lua_lock(L);
-  if ((L-&gt;top - L-&gt;base + size) &gt; LUAI_MAXCSTACK)
+  if (size &gt; LUAI_MAXCSTACK || (L-&gt;top - L-&gt;base + size) &gt; LUAI_MAXCSTACK)
     res = 0;  /* stack overflow */
-  else {
+  else if (size &gt; 0) {
     luaD_checkstack(L, size);
     if (L-&gt;ci-&gt;top &lt; L-&gt;top + size)
       L-&gt;ci-&gt;top = L-&gt;top + size;
-    res = 1;
   }
   lua_unlock(L);
   return res;
@@ -930,10 +929,13 @@
         g-&gt;GCthreshold = g-&gt;totalbytes - a;
       else
         g-&gt;GCthreshold = 0;
-      while (g-&gt;GCthreshold &lt;= g-&gt;totalbytes)
+      while (g-&gt;GCthreshold &lt;= g-&gt;totalbytes) {
         luaC_step(L);
-      if (g-&gt;gcstate == GCSpause)  /* end of cycle? */
-        res = 1;  /* signal it */
+        if (g-&gt;gcstate == GCSpause) {  /* end of cycle? */
+          res = 1;  /* signal it */
+          break;
+        }
+      }
       break;
     }
     case LUA_GCSETPAUSE: {

Modified: trunk/src/lua/lapi.h
===================================================================
--- trunk/src/lua/lapi.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lapi.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lapi.h,v 1.1.1.1 2008/07/11 13:12:20 bogdanm Exp $
+** $Id: lapi.h,v 2.2.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions from Lua API
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lauxlib.c
===================================================================
--- trunk/src/lua/lauxlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lauxlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lauxlib.c,v 1.1.1.1 2008/07/11 13:12:21 bogdanm Exp $
+** $Id: lauxlib.c,v 1.159.1.3 2008/01/21 13:20:51 roberto Exp $
 ** Auxiliary functions for building Lua libraries
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lauxlib.h
===================================================================
--- trunk/src/lua/lauxlib.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lauxlib.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lauxlib.h,v 1.1.1.1 2008/07/11 13:12:08 bogdanm Exp $
+** $Id: lauxlib.h,v 1.88.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions for building Lua libraries
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lbaselib.c
===================================================================
--- trunk/src/lua/lbaselib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lbaselib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lbaselib.c,v 1.1.1.1 2008/07/11 13:12:12 bogdanm Exp $
+** $Id: lbaselib.c,v 1.191.1.6 2008/02/14 16:46:22 roberto Exp $
 ** Basic library
 ** See Copyright Notice in lua.h
 */
@@ -344,10 +344,12 @@
   luaL_checktype(L, 1, LUA_TTABLE);
   i = luaL_optint(L, 2, 1);
   e = luaL_opt(L, luaL_checkint, 3, luaL_getn(L, 1));
+  if (i &gt; e) return 0;  /* empty range */
   n = e - i + 1;  /* number of elements */
-  if (n &lt;= 0) return 0;  /* empty range */
-  luaL_checkstack(L, n, &quot;table too big to unpack&quot;);
-  for (; i&lt;=e; i++)  /* push arg[i...e] */
+  if (n &lt;= 0 || !lua_checkstack(L, n))  /* n &lt;= 0 means arith. overflow */
+    return luaL_error(L, &quot;too many results to unpack&quot;);
+  lua_rawgeti(L, 1, i);  /* push arg[i] (avoiding overflow problems) */
+  while (i++ &lt; e)  /* push arg[i + 1...e] */
     lua_rawgeti(L, 1, i);
   return n;
 }
@@ -526,7 +528,7 @@
   status = lua_resume(co, narg);
   if (status == 0 || status == LUA_YIELD) {
     int nres = lua_gettop(co);
-    if (!lua_checkstack(L, nres))
+    if (!lua_checkstack(L, nres + 1))
       luaL_error(L, &quot;too many results to resume&quot;);
     lua_xmove(co, L, nres);  /* move yielded values */
     return nres;

Modified: trunk/src/lua/lcode.c
===================================================================
--- trunk/src/lua/lcode.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lcode.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lcode.c,v 1.1.1.1 2008/07/11 13:12:19 bogdanm Exp $
+** $Id: lcode.c,v 2.25.1.3 2007/12/28 15:32:23 roberto Exp $
 ** Code generator for Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lcode.h
===================================================================
--- trunk/src/lua/lcode.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lcode.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lcode.h,v 1.1.1.1 2008/07/11 13:12:10 bogdanm Exp $
+** $Id: lcode.h,v 1.48.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Code generator for Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ldblib.c
===================================================================
--- trunk/src/lua/ldblib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ldblib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldblib.c,v 1.1.1.1 2008/07/11 13:12:22 bogdanm Exp $
+** $Id: ldblib.c,v 1.104.1.3 2008/01/21 13:11:21 roberto Exp $
 ** Interface from Lua to its debug API
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ldebug.c
===================================================================
--- trunk/src/lua/ldebug.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ldebug.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldebug.c,v 1.1.1.1 2008/07/11 13:12:21 bogdanm Exp $
+** $Id: ldebug.c,v 2.29.1.6 2008/05/08 16:56:26 roberto Exp $
 ** Debug Interface
 ** See Copyright Notice in lua.h
 */
@@ -275,12 +275,12 @@
 
 static int precheck (const Proto *pt) {
   check(pt-&gt;maxstacksize &lt;= MAXSTACK);
-  lua_assert(pt-&gt;numparams+(pt-&gt;is_vararg &amp; VARARG_HASARG) &lt;= pt-&gt;maxstacksize);
-  lua_assert(!(pt-&gt;is_vararg &amp; VARARG_NEEDSARG) ||
+  check(pt-&gt;numparams+(pt-&gt;is_vararg &amp; VARARG_HASARG) &lt;= pt-&gt;maxstacksize);
+  check(!(pt-&gt;is_vararg &amp; VARARG_NEEDSARG) ||
               (pt-&gt;is_vararg &amp; VARARG_HASARG));
   check(pt-&gt;sizeupvalues &lt;= pt-&gt;nups);
   check(pt-&gt;sizelineinfo == pt-&gt;sizecode || pt-&gt;sizelineinfo == 0);
-  check(GET_OPCODE(pt-&gt;code[pt-&gt;sizecode-1]) == OP_RETURN);
+  check(pt-&gt;sizecode &gt; 0 &amp;&amp; GET_OPCODE(pt-&gt;code[pt-&gt;sizecode-1]) == OP_RETURN);
   return 1;
 }
 
@@ -346,9 +346,18 @@
           int dest = pc+1+b;
           check(0 &lt;= dest &amp;&amp; dest &lt; pt-&gt;sizecode);
           if (dest &gt; 0) {
-            /* cannot jump to a setlist count */
-            Instruction d = pt-&gt;code[dest-1];
-            check(!(GET_OPCODE(d) == OP_SETLIST &amp;&amp; GETARG_C(d) == 0));
+            int j;
+            /* check that it does not jump to a setlist count; this
+               is tricky, because the count from a previous setlist may
+               have the same value of an invalid setlist; so, we must
+               go all the way back to the first of them (if any) */
+            for (j = 0; j &lt; dest; j++) {
+              Instruction d = pt-&gt;code[dest-1-j];
+              if (!(GET_OPCODE(d) == OP_SETLIST &amp;&amp; GETARG_C(d) == 0)) break;
+            }
+            /* if 'j' is even, previous value is not a setlist (even if
+               it looks like one) */
+            check((j&amp;1) == 0);
           }
         }
         break;
@@ -363,7 +372,11 @@
     }
     switch (op) {
       case OP_LOADBOOL: {
-        check(c == 0 || pc+2 &lt; pt-&gt;sizecode);  /* check its jump */
+        if (c == 1) {  /* does it jump? */
+          check(pc+2 &lt; pt-&gt;sizecode);  /* check its jump */
+          check(GET_OPCODE(pt-&gt;code[pc+1]) != OP_SETLIST ||
+                GETARG_C(pt-&gt;code[pc+1]) != 0);
+        }
         break;
       }
       case OP_LOADNIL: {
@@ -428,7 +441,10 @@
       }
       case OP_SETLIST: {
         if (b &gt; 0) checkreg(pt, a + b);
-        if (c == 0) pc++;
+        if (c == 0) {
+          pc++;
+          check(pc &lt; pt-&gt;sizecode - 1);
+        }
         break;
       }
       case OP_CLOSURE: {

Modified: trunk/src/lua/ldebug.h
===================================================================
--- trunk/src/lua/ldebug.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ldebug.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldebug.h,v 1.1.1.1 2008/07/11 13:12:24 bogdanm Exp $
+** $Id: ldebug.h,v 2.3.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions from Debug Interface module
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ldo.c
===================================================================
--- trunk/src/lua/ldo.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ldo.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldo.c,v 1.1.1.1 2008/07/11 13:12:20 bogdanm Exp $
+** $Id: ldo.c,v 2.38.1.3 2008/01/18 22:31:22 roberto Exp $
 ** Stack and Call structure of Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ldo.h
===================================================================
--- trunk/src/lua/ldo.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ldo.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldo.h,v 1.1.1.1 2008/07/11 13:12:08 bogdanm Exp $
+** $Id: ldo.h,v 2.7.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Stack and Call structure of Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ldump.c
===================================================================
--- trunk/src/lua/ldump.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ldump.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldump.c,v 1.1.1.1 2008/07/11 13:12:22 bogdanm Exp $
+** $Id: ldump.c,v 2.8.1.1 2007/12/27 13:02:25 roberto Exp $
 ** save precompiled Lua chunks
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lfunc.c
===================================================================
--- trunk/src/lua/lfunc.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lfunc.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lfunc.c,v 1.1.1.1 2008/07/11 13:12:10 bogdanm Exp $
+** $Id: lfunc.c,v 2.12.1.2 2007/12/28 14:58:43 roberto Exp $
 ** Auxiliary functions to manipulate prototypes and closures
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lfunc.h
===================================================================
--- trunk/src/lua/lfunc.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lfunc.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lfunc.h,v 1.1.1.1 2008/07/11 13:12:11 bogdanm Exp $
+** $Id: lfunc.h,v 2.4.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions to manipulate prototypes and closures
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lgc.c
===================================================================
--- trunk/src/lua/lgc.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lgc.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lgc.c,v 1.1.1.1 2008/07/11 13:12:15 bogdanm Exp $
+** $Id: lgc.c,v 2.38.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Garbage Collector
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lgc.h
===================================================================
--- trunk/src/lua/lgc.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lgc.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lgc.h,v 1.1.1.1 2008/07/11 13:12:10 bogdanm Exp $
+** $Id: lgc.h,v 2.15.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Garbage Collector
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/linit.c
===================================================================
--- trunk/src/lua/linit.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/linit.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: linit.c,v 1.1.1.1 2008/07/11 13:12:10 bogdanm Exp $
+** $Id: linit.c,v 1.14.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Initialization of libraries for lua.c
 ** See Copyright Notice in lua.h
 */
@@ -17,16 +17,16 @@
 
 static const luaL_Reg lualibs[] = {
   {&quot;&quot;, luaopen_base},
-  {LUA_LOADLIBNAME, luaopen_package},
+//  {LUA_LOADLIBNAME, luaopen_package},
   {LUA_TABLIBNAME, luaopen_table},
   {LUA_IOLIBNAME, luaopen_io},
-  {LUA_OSLIBNAME, luaopen_os},
+//  {LUA_OSLIBNAME, luaopen_os},
   {LUA_STRLIBNAME, luaopen_string},
   {LUA_MATHLIBNAME, luaopen_math},
   {LUA_DBLIBNAME, luaopen_debug},
 #ifdef LUA_PLATFORM_LIBS  
   LUA_PLATFORM_LIBS,
-#endif
+#endif 
   {NULL, NULL}
 };
 

Modified: trunk/src/lua/liolib.c
===================================================================
--- trunk/src/lua/liolib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/liolib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: liolib.c,v 1.1.1.1 2008/07/11 13:12:19 bogdanm Exp $
+** $Id: liolib.c,v 2.73.1.3 2008/01/18 17:47:43 roberto Exp $
 ** Standard I/O (and system) library
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/llex.c
===================================================================
--- trunk/src/lua/llex.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/llex.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: llex.c,v 1.1.1.1 2008/07/11 13:12:09 bogdanm Exp $
+** $Id: llex.c,v 2.20.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lexical Analyzer
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/llex.h
===================================================================
--- trunk/src/lua/llex.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/llex.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: llex.h,v 1.1.1.1 2008/07/11 13:12:09 bogdanm Exp $
+** $Id: llex.h,v 1.58.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lexical Analyzer
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/llimits.h
===================================================================
--- trunk/src/lua/llimits.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/llimits.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: llimits.h,v 1.1.1.1 2008/07/11 13:12:09 bogdanm Exp $
+** $Id: llimits.h,v 1.69.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Limits, basic types, and some other `installation-dependent' definitions
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lmathlib.c
===================================================================
--- trunk/src/lua/lmathlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lmathlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lmathlib.c,v 1.1.1.1 2008/07/11 13:12:23 bogdanm Exp $
+** $Id: lmathlib.c,v 1.67.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Standard mathematical library
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lmem.c
===================================================================
--- trunk/src/lua/lmem.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lmem.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lmem.c,v 1.1.1.1 2008/07/11 13:12:21 bogdanm Exp $
+** $Id: lmem.c,v 1.70.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Interface to Memory Manager
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lmem.h
===================================================================
--- trunk/src/lua/lmem.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lmem.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lmem.h,v 1.1.1.1 2008/07/11 13:12:15 bogdanm Exp $
+** $Id: lmem.h,v 1.31.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Interface to Memory Manager
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/loadlib.c
===================================================================
--- trunk/src/lua/loadlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/loadlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: loadlib.c,v 1.1.1.1 2008/07/11 13:12:17 bogdanm Exp $
+** $Id: loadlib.c,v 1.52.1.3 2008/08/06 13:29:28 roberto Exp $
 ** Dynamic library loader for Lua
 ** See Copyright Notice in lua.h
 **
@@ -506,8 +506,10 @@
 
 static void setfenv (lua_State *L) {
   lua_Debug ar;
-  lua_getstack(L, 1, &amp;ar);
-  lua_getinfo(L, &quot;f&quot;, &amp;ar);
+  if (lua_getstack(L, 1, &amp;ar) == 0 ||
+      lua_getinfo(L, &quot;f&quot;, &amp;ar) == 0 ||  /* get calling function */
+      lua_iscfunction(L, -1))
+    luaL_error(L, LUA_QL(&quot;module&quot;) &quot; not called from a Lua function&quot;);
   lua_pushvalue(L, -2);
   lua_setfenv(L, -2);
   lua_pop(L, 1);

Modified: trunk/src/lua/lobject.c
===================================================================
--- trunk/src/lua/lobject.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lobject.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lobject.c,v 1.1.1.1 2008/07/11 13:12:14 bogdanm Exp $
+** $Id: lobject.c,v 2.22.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Some generic functions over Lua objects
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lobject.h
===================================================================
--- trunk/src/lua/lobject.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lobject.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lobject.h,v 1.1.1.1 2008/07/11 13:12:17 bogdanm Exp $
+** $Id: lobject.h,v 2.20.1.2 2008/08/06 13:29:48 roberto Exp $
 ** Type definitions for Lua objects
 ** See Copyright Notice in lua.h
 */
@@ -208,7 +208,7 @@
 
 
 #define getstr(ts)	cast(const char *, (ts) + 1)
-#define svalue(o)       getstr(tsvalue(o))
+#define svalue(o)       getstr(rawtsvalue(o))
 
 
 

Modified: trunk/src/lua/lopcodes.c
===================================================================
--- trunk/src/lua/lopcodes.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lopcodes.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lopcodes.c,v 1.1.1.1 2008/07/11 13:12:15 bogdanm Exp $
+** $Id: lopcodes.c,v 1.37.1.1 2007/12/27 13:02:25 roberto Exp $
 ** See Copyright Notice in lua.h
 */
 

Modified: trunk/src/lua/lopcodes.h
===================================================================
--- trunk/src/lua/lopcodes.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lopcodes.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lopcodes.h,v 1.1.1.1 2008/07/11 13:12:09 bogdanm Exp $
+** $Id: lopcodes.h,v 1.125.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Opcodes for Lua virtual machine
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/loslib.c
===================================================================
--- trunk/src/lua/loslib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/loslib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: loslib.c,v 1.1.1.1 2008/07/11 13:12:16 bogdanm Exp $
+** $Id: loslib.c,v 1.19.1.3 2008/01/18 16:38:18 roberto Exp $
 ** Standard Operating System library
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lparser.c
===================================================================
--- trunk/src/lua/lparser.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lparser.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lparser.c,v 1.1.1.1 2008/07/11 13:12:11 bogdanm Exp $
+** $Id: lparser.c,v 2.42.1.3 2007/12/28 15:32:23 roberto Exp $
 ** Lua Parser
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lparser.h
===================================================================
--- trunk/src/lua/lparser.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lparser.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lparser.h,v 1.1.1.1 2008/07/11 13:12:17 bogdanm Exp $
+** $Id: lparser.h,v 1.57.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua Parser
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lstate.c
===================================================================
--- trunk/src/lua/lstate.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lstate.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstate.c,v 1.1.1.1 2008/07/11 13:12:10 bogdanm Exp $
+** $Id: lstate.c,v 2.36.1.2 2008/01/03 15:20:39 roberto Exp $
 ** Global State
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lstate.h
===================================================================
--- trunk/src/lua/lstate.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lstate.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstate.h,v 1.1.1.1 2008/07/11 13:12:16 bogdanm Exp $
+** $Id: lstate.h,v 2.24.1.2 2008/01/03 15:20:39 roberto Exp $
 ** Global State
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lstring.c
===================================================================
--- trunk/src/lua/lstring.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lstring.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstring.c,v 1.1.1.1 2008/07/11 13:12:15 bogdanm Exp $
+** $Id: lstring.c,v 2.8.1.1 2007/12/27 13:02:25 roberto Exp $
 ** String table (keeps all strings handled by Lua)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lstring.h
===================================================================
--- trunk/src/lua/lstring.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lstring.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstring.h,v 1.1.1.1 2008/07/11 13:12:09 bogdanm Exp $
+** $Id: lstring.h,v 1.43.1.1 2007/12/27 13:02:25 roberto Exp $
 ** String table (keep all strings handled by Lua)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lstrlib.c
===================================================================
--- trunk/src/lua/lstrlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lstrlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstrlib.c,v 1.1.1.1 2008/07/11 13:12:17 bogdanm Exp $
+** $Id: lstrlib.c,v 1.132.1.4 2008/07/11 17:27:21 roberto Exp $
 ** Standard library for string operations and pattern-matching
 ** See Copyright Notice in lua.h
 */
@@ -35,7 +35,8 @@
 
 static ptrdiff_t posrelat (ptrdiff_t pos, size_t len) {
   /* relative string position: negative means back from end */
-  return (pos&gt;=0) ? pos : (ptrdiff_t)len+pos+1;
+  if (pos &lt; 0) pos += (ptrdiff_t)len + 1;
+  return (pos &gt;= 0) ? pos : 0;
 }
 
 

Modified: trunk/src/lua/ltable.c
===================================================================
--- trunk/src/lua/ltable.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ltable.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltable.c,v 1.1.1.1 2008/07/11 13:12:15 bogdanm Exp $
+** $Id: ltable.c,v 2.32.1.2 2007/12/28 15:32:23 roberto Exp $
 ** Lua tables (hash)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ltable.h
===================================================================
--- trunk/src/lua/ltable.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ltable.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltable.h,v 1.1.1.1 2008/07/11 13:12:11 bogdanm Exp $
+** $Id: ltable.h,v 2.10.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua tables (hash)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ltablib.c
===================================================================
--- trunk/src/lua/ltablib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ltablib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltablib.c,v 1.1.1.1 2008/07/11 13:12:09 bogdanm Exp $
+** $Id: ltablib.c,v 1.38.1.3 2008/02/14 16:46:58 roberto Exp $
 ** Library for Table Manipulation
 ** See Copyright Notice in lua.h
 */
@@ -132,6 +132,15 @@
 }
 
 
+static void addfield (lua_State *L, luaL_Buffer *b, int i) {
+  lua_rawgeti(L, 1, i);
+  if (!lua_isstring(L, -1))
+    luaL_error(L, &quot;invalid value (%s) at index %d in table for &quot;
+                  LUA_QL(&quot;concat&quot;), luaL_typename(L, -1), i);
+    luaL_addvalue(b);
+}
+
+
 static int tconcat (lua_State *L) {
   luaL_Buffer b;
   size_t lsep;
@@ -141,13 +150,12 @@
   i = luaL_optint(L, 3, 1);
   last = luaL_opt(L, luaL_checkint, 4, luaL_getn(L, 1));
   luaL_buffinit(L, &amp;b);
-  for (; i &lt;= last; i++) {
-    lua_rawgeti(L, 1, i);
-    luaL_argcheck(L, lua_isstring(L, -1), 1, &quot;table contains non-strings&quot;);
-    luaL_addvalue(&amp;b);
-    if (i != last)
-      luaL_addlstring(&amp;b, sep, lsep);
+  for (; i &lt; last; i++) {
+    addfield(L, &amp;b, i);
+    luaL_addlstring(&amp;b, sep, lsep);
   }
+  if (i == last)  /* add last value (if interval was not empty) */
+    addfield(L, &amp;b, i);
   luaL_pushresult(&amp;b);
   return 1;
 }

Modified: trunk/src/lua/ltm.c
===================================================================
--- trunk/src/lua/ltm.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ltm.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltm.c,v 1.1.1.1 2008/07/11 13:12:15 bogdanm Exp $
+** $Id: ltm.c,v 2.8.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Tag methods
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/ltm.h
===================================================================
--- trunk/src/lua/ltm.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/ltm.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltm.h,v 1.1.1.1 2008/07/11 13:12:17 bogdanm Exp $
+** $Id: ltm.h,v 2.6.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Tag methods
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lua.c
===================================================================
--- trunk/src/lua/lua.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lua.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lua.c,v 1.1.1.1 2008/07/11 13:12:20 bogdanm Exp $
+** $Id: lua.c,v 1.160.1.2 2007/12/28 15:32:23 roberto Exp $
 ** Lua stand-alone interpreter
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lua.h
===================================================================
--- trunk/src/lua/lua.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lua.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lua.h,v 1.1.1.1 2008/07/11 13:12:24 bogdanm Exp $
+** $Id: lua.h,v 1.218.1.5 2008/08/06 13:30:12 roberto Exp $
 ** Lua - An Extensible Extension Language
 ** Lua.org, PUC-Rio, Brazil (<A HREF="http://www.lua.org">http://www.lua.org</A>)
 ** See Copyright Notice at the end of this file
@@ -17,7 +17,7 @@
 
 
 #define LUA_VERSION	&quot;Lua 5.1&quot;
-#define LUA_RELEASE	&quot;Lua 5.1.3&quot;
+#define LUA_RELEASE	&quot;Lua 5.1.4&quot;
 #define LUA_VERSION_NUM	501
 #define LUA_COPYRIGHT	&quot;Copyright (C) 1994-2008 Lua.org, PUC-Rio&quot;
 #define LUA_AUTHORS 	&quot;R. Ierusalimschy, L. H. de Figueiredo &amp; W. Celes&quot;

Modified: trunk/src/lua/luac.c
===================================================================
--- trunk/src/lua/luac.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/luac.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: luac.c,v 1.1.1.1 2008/07/11 13:12:18 bogdanm Exp $
+** $Id: luac.c,v 1.54 2006/06/02 17:37:11 lhf Exp $
 ** Lua compiler (saves bytecodes to files; also list bytecodes)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/luaconf.h
===================================================================
--- trunk/src/lua/luaconf.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/luaconf.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: luaconf.h,v 1.1.1.1 2008/07/11 13:12:23 bogdanm Exp $
+** $Id: luaconf.h,v 1.82.1.7 2008/02/11 16:25:08 roberto Exp $
 ** Configuration file for Lua
 ** See Copyright Notice in lua.h
 */
@@ -440,10 +440,10 @@
 @* can use.
 ** CHANGE it if you need lots of (Lua) stack space for your C
 ** functions. This limit is arbitrary; its only purpose is to stop C
-** functions to consume unlimited stack space.
+** functions to consume unlimited stack space. (must be smaller than
+** -LUA_REGISTRYINDEX)
 */
-#define LUAI_MCS_AUX	((int)(INT_MAX / (4*sizeof(LUA_NUMBER))))
-#define LUAI_MAXCSTACK	(LUAI_MCS_AUX &gt; SHRT_MAX ? SHRT_MAX : LUAI_MCS_AUX)
+#define LUAI_MAXCSTACK	8000
 
 
 

Modified: trunk/src/lua/lualib.h
===================================================================
--- trunk/src/lua/lualib.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lualib.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lualib.h,v 1.1.1.1 2008/07/11 13:12:21 bogdanm Exp $
+** $Id: lualib.h,v 1.36.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua standard libraries
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lundump.c
===================================================================
--- trunk/src/lua/lundump.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lundump.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lundump.c,v 1.1.1.1 2008/07/11 13:12:23 bogdanm Exp $
+** $Id: lundump.c,v 2.7.1.4 2008/04/04 19:51:41 roberto Exp $
 ** load precompiled Lua chunks
 ** See Copyright Notice in lua.h
 */
@@ -48,7 +48,6 @@
 static void LoadBlock(LoadState* S, void* b, size_t size)
 {
  size_t r=luaZ_read(S-&gt;Z,b,size);
- UNUSED(r);
  IF (r!=0, &quot;unexpected end&quot;);
 }
 
@@ -115,7 +114,7 @@
    	setnilvalue(o);
 	break;
    case LUA_TBOOLEAN:
-   	setbvalue(o,LoadChar(S));
+   	setbvalue(o,LoadChar(S)!=0);
 	break;
    case LUA_TNUMBER:
 	setnvalue(o,LoadNumber(S));
@@ -161,7 +160,9 @@
 
 static Proto* LoadFunction(LoadState* S, TString* p)
 {
- Proto* f=luaF_newproto(S-&gt;L);
+ Proto* f;
+ if (++S-&gt;L-&gt;nCcalls &gt; LUAI_MAXCCALLS) error(S,&quot;code too deep&quot;);
+ f=luaF_newproto(S-&gt;L);
  setptvalue2s(S-&gt;L,S-&gt;L-&gt;top,f); incr_top(S-&gt;L);
  f-&gt;source=LoadString(S); if (f-&gt;source==NULL) f-&gt;source=p;
  f-&gt;linedefined=LoadInt(S);
@@ -175,6 +176,7 @@
  LoadDebug(S,f);
  IF (!luaG_checkcode(f), &quot;bad code&quot;);
  S-&gt;L-&gt;top--;
+ S-&gt;L-&gt;nCcalls--;
  return f;
 }
 

Modified: trunk/src/lua/lundump.h
===================================================================
--- trunk/src/lua/lundump.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lundump.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lundump.h,v 1.1.1.1 2008/07/11 13:12:20 bogdanm Exp $
+** $Id: lundump.h,v 1.37.1.1 2007/12/27 13:02:25 roberto Exp $
 ** load precompiled Lua chunks
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lvm.c
===================================================================
--- trunk/src/lua/lvm.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lvm.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lvm.c,v 1.1.1.1 2008/07/11 13:12:13 bogdanm Exp $
+** $Id: lvm.c,v 2.63.1.3 2007/12/28 15:32:23 roberto Exp $
 ** Lua virtual machine
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lvm.h
===================================================================
--- trunk/src/lua/lvm.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lvm.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lvm.h,v 1.1.1.1 2008/07/11 13:12:21 bogdanm Exp $
+** $Id: lvm.h,v 2.5.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua virtual machine
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lzio.c
===================================================================
--- trunk/src/lua/lzio.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lzio.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lzio.c,v 1.1.1.1 2008/07/11 13:12:15 bogdanm Exp $
+** $Id: lzio.c,v 1.31.1.1 2007/12/27 13:02:25 roberto Exp $
 ** a generic input stream interface
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/lzio.h
===================================================================
--- trunk/src/lua/lzio.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/lzio.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lzio.h,v 1.1.1.1 2008/07/11 13:12:22 bogdanm Exp $
+** $Id: lzio.h,v 1.21.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Buffered streams
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lua/print.c
===================================================================
--- trunk/src/lua/print.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lua/print.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: print.c,v 1.1.1.1 2008/07/11 13:12:10 bogdanm Exp $
+** $Id: print.c,v 1.55a 2006/05/31 13:30:05 lhf Exp $
 ** print bytecodes
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lapi.c
===================================================================
--- trunk/src/lualong/lapi.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lapi.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lapi.c,v 1.1.1.1 2008/07/11 13:11:58 bogdanm Exp $
+** $Id: lapi.c,v 2.55.1.5 2008/07/04 18:41:18 roberto Exp $
 ** Lua API
 ** See Copyright Notice in lua.h
 */
@@ -93,15 +93,14 @@
 
 
 LUA_API int lua_checkstack (lua_State *L, int size) {
-  int res;
+  int res = 1;
   lua_lock(L);
-  if ((L-&gt;top - L-&gt;base + size) &gt; LUAI_MAXCSTACK)
+  if (size &gt; LUAI_MAXCSTACK || (L-&gt;top - L-&gt;base + size) &gt; LUAI_MAXCSTACK)
     res = 0;  /* stack overflow */
-  else {
+  else if (size &gt; 0) {
     luaD_checkstack(L, size);
     if (L-&gt;ci-&gt;top &lt; L-&gt;top + size)
       L-&gt;ci-&gt;top = L-&gt;top + size;
-    res = 1;
   }
   lua_unlock(L);
   return res;
@@ -930,10 +929,13 @@
         g-&gt;GCthreshold = g-&gt;totalbytes - a;
       else
         g-&gt;GCthreshold = 0;
-      while (g-&gt;GCthreshold &lt;= g-&gt;totalbytes)
+      while (g-&gt;GCthreshold &lt;= g-&gt;totalbytes) {
         luaC_step(L);
-      if (g-&gt;gcstate == GCSpause)  /* end of cycle? */
-        res = 1;  /* signal it */
+        if (g-&gt;gcstate == GCSpause) {  /* end of cycle? */
+          res = 1;  /* signal it */
+          break;
+        }
+      }
       break;
     }
     case LUA_GCSETPAUSE: {

Modified: trunk/src/lualong/lapi.h
===================================================================
--- trunk/src/lualong/lapi.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lapi.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lapi.h,v 1.1.1.1 2008/07/11 13:12:05 bogdanm Exp $
+** $Id: lapi.h,v 2.2.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions from Lua API
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lauxlib.c
===================================================================
--- trunk/src/lualong/lauxlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lauxlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lauxlib.c,v 1.1.1.1 2008/07/11 13:12:05 bogdanm Exp $
+** $Id: lauxlib.c,v 1.159.1.3 2008/01/21 13:20:51 roberto Exp $
 ** Auxiliary functions for building Lua libraries
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lauxlib.h
===================================================================
--- trunk/src/lualong/lauxlib.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lauxlib.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lauxlib.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: lauxlib.h,v 1.88.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions for building Lua libraries
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lbaselib.c
===================================================================
--- trunk/src/lualong/lbaselib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lbaselib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lbaselib.c,v 1.1.1.1 2008/07/11 13:11:56 bogdanm Exp $
+** $Id: lbaselib.c,v 1.191.1.6 2008/02/14 16:46:22 roberto Exp $
 ** Basic library
 ** See Copyright Notice in lua.h
 */
@@ -344,10 +344,12 @@
   luaL_checktype(L, 1, LUA_TTABLE);
   i = luaL_optint(L, 2, 1);
   e = luaL_opt(L, luaL_checkint, 3, luaL_getn(L, 1));
+  if (i &gt; e) return 0;  /* empty range */
   n = e - i + 1;  /* number of elements */
-  if (n &lt;= 0) return 0;  /* empty range */
-  luaL_checkstack(L, n, &quot;table too big to unpack&quot;);
-  for (; i&lt;=e; i++)  /* push arg[i...e] */
+  if (n &lt;= 0 || !lua_checkstack(L, n))  /* n &lt;= 0 means arith. overflow */
+    return luaL_error(L, &quot;too many results to unpack&quot;);
+  lua_rawgeti(L, 1, i);  /* push arg[i] (avoiding overflow problems) */
+  while (i++ &lt; e)  /* push arg[i + 1...e] */
     lua_rawgeti(L, 1, i);
   return n;
 }
@@ -526,7 +528,7 @@
   status = lua_resume(co, narg);
   if (status == 0 || status == LUA_YIELD) {
     int nres = lua_gettop(co);
-    if (!lua_checkstack(L, nres))
+    if (!lua_checkstack(L, nres + 1))
       luaL_error(L, &quot;too many results to resume&quot;);
     lua_xmove(co, L, nres);  /* move yielded values */
     return nres;

Modified: trunk/src/lualong/lcode.c
===================================================================
--- trunk/src/lualong/lcode.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lcode.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lcode.c,v 1.1.1.1 2008/07/11 13:12:03 bogdanm Exp $
+** $Id: lcode.c,v 2.25.1.3 2007/12/28 15:32:23 roberto Exp $
 ** Code generator for Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lcode.h
===================================================================
--- trunk/src/lualong/lcode.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lcode.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lcode.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: lcode.h,v 1.48.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Code generator for Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ldblib.c
===================================================================
--- trunk/src/lualong/ldblib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ldblib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldblib.c,v 1.1.1.1 2008/07/11 13:12:06 bogdanm Exp $
+** $Id: ldblib.c,v 1.104.1.3 2008/01/21 13:11:21 roberto Exp $
 ** Interface from Lua to its debug API
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ldebug.c
===================================================================
--- trunk/src/lualong/ldebug.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ldebug.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldebug.c,v 1.1.1.1 2008/07/11 13:12:06 bogdanm Exp $
+** $Id: ldebug.c,v 2.29.1.6 2008/05/08 16:56:26 roberto Exp $
 ** Debug Interface
 ** See Copyright Notice in lua.h
 */
@@ -275,12 +275,12 @@
 
 static int precheck (const Proto *pt) {
   check(pt-&gt;maxstacksize &lt;= MAXSTACK);
-  lua_assert(pt-&gt;numparams+(pt-&gt;is_vararg &amp; VARARG_HASARG) &lt;= pt-&gt;maxstacksize);
-  lua_assert(!(pt-&gt;is_vararg &amp; VARARG_NEEDSARG) ||
+  check(pt-&gt;numparams+(pt-&gt;is_vararg &amp; VARARG_HASARG) &lt;= pt-&gt;maxstacksize);
+  check(!(pt-&gt;is_vararg &amp; VARARG_NEEDSARG) ||
               (pt-&gt;is_vararg &amp; VARARG_HASARG));
   check(pt-&gt;sizeupvalues &lt;= pt-&gt;nups);
   check(pt-&gt;sizelineinfo == pt-&gt;sizecode || pt-&gt;sizelineinfo == 0);
-  check(GET_OPCODE(pt-&gt;code[pt-&gt;sizecode-1]) == OP_RETURN);
+  check(pt-&gt;sizecode &gt; 0 &amp;&amp; GET_OPCODE(pt-&gt;code[pt-&gt;sizecode-1]) == OP_RETURN);
   return 1;
 }
 
@@ -346,9 +346,18 @@
           int dest = pc+1+b;
           check(0 &lt;= dest &amp;&amp; dest &lt; pt-&gt;sizecode);
           if (dest &gt; 0) {
-            /* cannot jump to a setlist count */
-            Instruction d = pt-&gt;code[dest-1];
-            check(!(GET_OPCODE(d) == OP_SETLIST &amp;&amp; GETARG_C(d) == 0));
+            int j;
+            /* check that it does not jump to a setlist count; this
+               is tricky, because the count from a previous setlist may
+               have the same value of an invalid setlist; so, we must
+               go all the way back to the first of them (if any) */
+            for (j = 0; j &lt; dest; j++) {
+              Instruction d = pt-&gt;code[dest-1-j];
+              if (!(GET_OPCODE(d) == OP_SETLIST &amp;&amp; GETARG_C(d) == 0)) break;
+            }
+            /* if 'j' is even, previous value is not a setlist (even if
+               it looks like one) */
+            check((j&amp;1) == 0);
           }
         }
         break;
@@ -363,7 +372,11 @@
     }
     switch (op) {
       case OP_LOADBOOL: {
-        check(c == 0 || pc+2 &lt; pt-&gt;sizecode);  /* check its jump */
+        if (c == 1) {  /* does it jump? */
+          check(pc+2 &lt; pt-&gt;sizecode);  /* check its jump */
+          check(GET_OPCODE(pt-&gt;code[pc+1]) != OP_SETLIST ||
+                GETARG_C(pt-&gt;code[pc+1]) != 0);
+        }
         break;
       }
       case OP_LOADNIL: {
@@ -428,7 +441,10 @@
       }
       case OP_SETLIST: {
         if (b &gt; 0) checkreg(pt, a + b);
-        if (c == 0) pc++;
+        if (c == 0) {
+          pc++;
+          check(pc &lt; pt-&gt;sizecode - 1);
+        }
         break;
       }
       case OP_CLOSURE: {

Modified: trunk/src/lualong/ldebug.h
===================================================================
--- trunk/src/lualong/ldebug.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ldebug.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldebug.h,v 1.1.1.1 2008/07/11 13:12:08 bogdanm Exp $
+** $Id: ldebug.h,v 2.3.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions from Debug Interface module
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ldo.c
===================================================================
--- trunk/src/lualong/ldo.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ldo.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldo.c,v 1.1.1.1 2008/07/11 13:12:05 bogdanm Exp $
+** $Id: ldo.c,v 2.38.1.3 2008/01/18 22:31:22 roberto Exp $
 ** Stack and Call structure of Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ldo.h
===================================================================
--- trunk/src/lualong/ldo.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ldo.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldo.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: ldo.h,v 2.7.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Stack and Call structure of Lua
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ldump.c
===================================================================
--- trunk/src/lualong/ldump.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ldump.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ldump.c,v 1.1.1.1 2008/07/11 13:12:06 bogdanm Exp $
+** $Id: ldump.c,v 2.8.1.1 2007/12/27 13:02:25 roberto Exp $
 ** save precompiled Lua chunks
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lfunc.c
===================================================================
--- trunk/src/lualong/lfunc.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lfunc.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lfunc.c,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: lfunc.c,v 2.12.1.2 2007/12/28 14:58:43 roberto Exp $
 ** Auxiliary functions to manipulate prototypes and closures
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lfunc.h
===================================================================
--- trunk/src/lualong/lfunc.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lfunc.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lfunc.h,v 1.1.1.1 2008/07/11 13:11:56 bogdanm Exp $
+** $Id: lfunc.h,v 2.4.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Auxiliary functions to manipulate prototypes and closures
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lgc.c
===================================================================
--- trunk/src/lualong/lgc.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lgc.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lgc.c,v 1.1.1.1 2008/07/11 13:11:59 bogdanm Exp $
+** $Id: lgc.c,v 2.38.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Garbage Collector
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lgc.h
===================================================================
--- trunk/src/lualong/lgc.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lgc.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lgc.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: lgc.h,v 2.15.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Garbage Collector
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/linit.c
===================================================================
--- trunk/src/lualong/linit.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/linit.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: linit.c,v 1.1.1.1 2008/07/11 13:11:55 bogdanm Exp $
+** $Id: linit.c,v 1.14.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Initialization of libraries for lua.c
 ** See Copyright Notice in lua.h
 */
@@ -17,18 +17,18 @@
 
 static const luaL_Reg lualibs[] = {
   {&quot;&quot;, luaopen_base},
-  {LUA_LOADLIBNAME, luaopen_package},
+//  {LUA_LOADLIBNAME, luaopen_package},
   {LUA_TABLIBNAME, luaopen_table},
   {LUA_IOLIBNAME, luaopen_io},
-  {LUA_OSLIBNAME, luaopen_os},
+//  {LUA_OSLIBNAME, luaopen_os},
   {LUA_STRLIBNAME, luaopen_string},
-#if !defined LUA_NUMBER_INTEGRAL  
+#if !defined LUA_NUMBER_INTEGRAL    
   {LUA_MATHLIBNAME, luaopen_math},
-#endif
+#endif 
   {LUA_DBLIBNAME, luaopen_debug},
 #ifdef LUA_PLATFORM_LIBS  
   LUA_PLATFORM_LIBS,
-#endif  
+#endif 
   {NULL, NULL}
 };
 

Modified: trunk/src/lualong/liolib.c
===================================================================
--- trunk/src/lualong/liolib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/liolib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: liolib.c,v 1.1.1.1 2008/07/11 13:12:04 bogdanm Exp $
+** $Id: liolib.c,v 2.73.1.3 2008/01/18 17:47:43 roberto Exp $
 ** Standard I/O (and system) library
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/llex.c
===================================================================
--- trunk/src/lualong/llex.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/llex.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: llex.c,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: llex.c,v 2.20.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lexical Analyzer
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/llex.h
===================================================================
--- trunk/src/lualong/llex.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/llex.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: llex.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: llex.h,v 1.58.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lexical Analyzer
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/llimits.h
===================================================================
--- trunk/src/lualong/llimits.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/llimits.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: llimits.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: llimits.h,v 1.69.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Limits, basic types, and some other `installation-dependent' definitions
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lmathlib.c
===================================================================
--- trunk/src/lualong/lmathlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lmathlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lmathlib.c,v 1.1.1.1 2008/07/11 13:12:07 bogdanm Exp $
+** $Id: lmathlib.c,v 1.67.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Standard mathematical library
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lmem.c
===================================================================
--- trunk/src/lualong/lmem.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lmem.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lmem.c,v 1.1.1.1 2008/07/11 13:12:05 bogdanm Exp $
+** $Id: lmem.c,v 1.70.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Interface to Memory Manager
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lmem.h
===================================================================
--- trunk/src/lualong/lmem.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lmem.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lmem.h,v 1.1.1.1 2008/07/11 13:11:59 bogdanm Exp $
+** $Id: lmem.h,v 1.31.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Interface to Memory Manager
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/loadlib.c
===================================================================
--- trunk/src/lualong/loadlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/loadlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: loadlib.c,v 1.1.1.1 2008/07/11 13:12:01 bogdanm Exp $
+** $Id: loadlib.c,v 1.52.1.3 2008/08/06 13:29:28 roberto Exp $
 ** Dynamic library loader for Lua
 ** See Copyright Notice in lua.h
 **
@@ -506,8 +506,10 @@
 
 static void setfenv (lua_State *L) {
   lua_Debug ar;
-  lua_getstack(L, 1, &amp;ar);
-  lua_getinfo(L, &quot;f&quot;, &amp;ar);
+  if (lua_getstack(L, 1, &amp;ar) == 0 ||
+      lua_getinfo(L, &quot;f&quot;, &amp;ar) == 0 ||  /* get calling function */
+      lua_iscfunction(L, -1))
+    luaL_error(L, LUA_QL(&quot;module&quot;) &quot; not called from a Lua function&quot;);
   lua_pushvalue(L, -2);
   lua_setfenv(L, -2);
   lua_pop(L, 1);

Modified: trunk/src/lualong/lobject.c
===================================================================
--- trunk/src/lualong/lobject.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lobject.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lobject.c,v 1.1.1.1 2008/07/11 13:11:58 bogdanm Exp $
+** $Id: lobject.c,v 2.22.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Some generic functions over Lua objects
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lobject.h
===================================================================
--- trunk/src/lualong/lobject.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lobject.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lobject.h,v 1.1.1.1 2008/07/11 13:12:01 bogdanm Exp $
+** $Id: lobject.h,v 2.20.1.2 2008/08/06 13:29:48 roberto Exp $
 ** Type definitions for Lua objects
 ** See Copyright Notice in lua.h
 */
@@ -208,7 +208,7 @@
 
 
 #define getstr(ts)	cast(const char *, (ts) + 1)
-#define svalue(o)       getstr(tsvalue(o))
+#define svalue(o)       getstr(rawtsvalue(o))
 
 
 

Modified: trunk/src/lualong/lopcodes.c
===================================================================
--- trunk/src/lualong/lopcodes.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lopcodes.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lopcodes.c,v 1.1.1.1 2008/07/11 13:11:59 bogdanm Exp $
+** $Id: lopcodes.c,v 1.37.1.1 2007/12/27 13:02:25 roberto Exp $
 ** See Copyright Notice in lua.h
 */
 

Modified: trunk/src/lualong/lopcodes.h
===================================================================
--- trunk/src/lualong/lopcodes.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lopcodes.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lopcodes.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: lopcodes.h,v 1.125.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Opcodes for Lua virtual machine
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/loslib.c
===================================================================
--- trunk/src/lualong/loslib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/loslib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: loslib.c,v 1.1.1.1 2008/07/11 13:12:00 bogdanm Exp $
+** $Id: loslib.c,v 1.19.1.3 2008/01/18 16:38:18 roberto Exp $
 ** Standard Operating System library
 ** See Copyright Notice in lua.h
 */
@@ -223,7 +223,7 @@
   {&quot;date&quot;,      os_date},
 #if !defined LUA_NUMBER_INTEGRAL  
   {&quot;difftime&quot;,  os_difftime},
-#endif  
+#endif
   {&quot;execute&quot;,   os_execute},
   {&quot;exit&quot;,      os_exit},
   {&quot;getenv&quot;,    os_getenv},

Modified: trunk/src/lualong/lparser.c
===================================================================
--- trunk/src/lualong/lparser.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lparser.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lparser.c,v 1.1.1.1 2008/07/11 13:11:56 bogdanm Exp $
+** $Id: lparser.c,v 2.42.1.3 2007/12/28 15:32:23 roberto Exp $
 ** Lua Parser
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lparser.h
===================================================================
--- trunk/src/lualong/lparser.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lparser.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lparser.h,v 1.1.1.1 2008/07/11 13:12:00 bogdanm Exp $
+** $Id: lparser.h,v 1.57.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua Parser
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lstate.c
===================================================================
--- trunk/src/lualong/lstate.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lstate.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstate.c,v 1.1.1.1 2008/07/11 13:11:55 bogdanm Exp $
+** $Id: lstate.c,v 2.36.1.2 2008/01/03 15:20:39 roberto Exp $
 ** Global State
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lstate.h
===================================================================
--- trunk/src/lualong/lstate.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lstate.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstate.h,v 1.1.1.1 2008/07/11 13:12:00 bogdanm Exp $
+** $Id: lstate.h,v 2.24.1.2 2008/01/03 15:20:39 roberto Exp $
 ** Global State
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lstring.c
===================================================================
--- trunk/src/lualong/lstring.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lstring.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstring.c,v 1.1.1.1 2008/07/11 13:11:59 bogdanm Exp $
+** $Id: lstring.c,v 2.8.1.1 2007/12/27 13:02:25 roberto Exp $
 ** String table (keeps all strings handled by Lua)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lstring.h
===================================================================
--- trunk/src/lualong/lstring.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lstring.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstring.h,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: lstring.h,v 1.43.1.1 2007/12/27 13:02:25 roberto Exp $
 ** String table (keep all strings handled by Lua)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lstrlib.c
===================================================================
--- trunk/src/lualong/lstrlib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lstrlib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lstrlib.c,v 1.1.1.1 2008/07/11 13:12:02 bogdanm Exp $
+** $Id: lstrlib.c,v 1.132.1.4 2008/07/11 17:27:21 roberto Exp $
 ** Standard library for string operations and pattern-matching
 ** See Copyright Notice in lua.h
 */
@@ -35,7 +35,8 @@
 
 static ptrdiff_t posrelat (ptrdiff_t pos, size_t len) {
   /* relative string position: negative means back from end */
-  return (pos&gt;=0) ? pos : (ptrdiff_t)len+pos+1;
+  if (pos &lt; 0) pos += (ptrdiff_t)len + 1;
+  return (pos &gt;= 0) ? pos : 0;
 }
 
 
@@ -790,7 +791,7 @@
           sprintf(buff, form, (double)luaL_checknumber(L, arg));
           break;
         }
-#endif        
+#endif
         case 'q': {
           addquoted(L, &amp;b, arg);
           continue;  /* skip the 'addsize' at the end */

Modified: trunk/src/lualong/ltable.c
===================================================================
--- trunk/src/lualong/ltable.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ltable.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltable.c,v 1.1.1.1 2008/07/11 13:12:00 bogdanm Exp $
+** $Id: ltable.c,v 2.32.1.2 2007/12/28 15:32:23 roberto Exp $
 ** Lua tables (hash)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ltable.h
===================================================================
--- trunk/src/lualong/ltable.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ltable.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltable.h,v 1.1.1.1 2008/07/11 13:11:56 bogdanm Exp $
+** $Id: ltable.h,v 2.10.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua tables (hash)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ltablib.c
===================================================================
--- trunk/src/lualong/ltablib.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ltablib.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltablib.c,v 1.1.1.1 2008/07/11 13:11:54 bogdanm Exp $
+** $Id: ltablib.c,v 1.38.1.3 2008/02/14 16:46:58 roberto Exp $
 ** Library for Table Manipulation
 ** See Copyright Notice in lua.h
 */
@@ -132,6 +132,15 @@
 }
 
 
+static void addfield (lua_State *L, luaL_Buffer *b, int i) {
+  lua_rawgeti(L, 1, i);
+  if (!lua_isstring(L, -1))
+    luaL_error(L, &quot;invalid value (%s) at index %d in table for &quot;
+                  LUA_QL(&quot;concat&quot;), luaL_typename(L, -1), i);
+    luaL_addvalue(b);
+}
+
+
 static int tconcat (lua_State *L) {
   luaL_Buffer b;
   size_t lsep;
@@ -141,13 +150,12 @@
   i = luaL_optint(L, 3, 1);
   last = luaL_opt(L, luaL_checkint, 4, luaL_getn(L, 1));
   luaL_buffinit(L, &amp;b);
-  for (; i &lt;= last; i++) {
-    lua_rawgeti(L, 1, i);
-    luaL_argcheck(L, lua_isstring(L, -1), 1, &quot;table contains non-strings&quot;);
-    luaL_addvalue(&amp;b);
-    if (i != last)
-      luaL_addlstring(&amp;b, sep, lsep);
+  for (; i &lt; last; i++) {
+    addfield(L, &amp;b, i);
+    luaL_addlstring(&amp;b, sep, lsep);
   }
+  if (i == last)  /* add last value (if interval was not empty) */
+    addfield(L, &amp;b, i);
   luaL_pushresult(&amp;b);
   return 1;
 }

Modified: trunk/src/lualong/ltm.c
===================================================================
--- trunk/src/lualong/ltm.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ltm.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltm.c,v 1.1.1.1 2008/07/11 13:11:59 bogdanm Exp $
+** $Id: ltm.c,v 2.8.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Tag methods
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/ltm.h
===================================================================
--- trunk/src/lualong/ltm.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/ltm.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: ltm.h,v 1.1.1.1 2008/07/11 13:12:01 bogdanm Exp $
+** $Id: ltm.h,v 2.6.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Tag methods
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lua.c
===================================================================
--- trunk/src/lualong/lua.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lua.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lua.c,v 1.1.1.1 2008/07/11 13:12:04 bogdanm Exp $
+** $Id: lua.c,v 1.160.1.2 2007/12/28 15:32:23 roberto Exp $
 ** Lua stand-alone interpreter
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lua.h
===================================================================
--- trunk/src/lualong/lua.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lua.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lua.h,v 1.1.1.1 2008/07/11 13:12:08 bogdanm Exp $
+** $Id: lua.h,v 1.218.1.5 2008/08/06 13:30:12 roberto Exp $
 ** Lua - An Extensible Extension Language
 ** Lua.org, PUC-Rio, Brazil (<A HREF="http://www.lua.org">http://www.lua.org</A>)
 ** See Copyright Notice at the end of this file
@@ -17,7 +17,7 @@
 
 
 #define LUA_VERSION	&quot;Lua 5.1&quot;
-#define LUA_RELEASE	&quot;Lua 5.1.3&quot;
+#define LUA_RELEASE	&quot;Lua 5.1.4&quot;
 #define LUA_VERSION_NUM	501
 #define LUA_COPYRIGHT	&quot;Copyright (C) 1994-2008 Lua.org, PUC-Rio&quot;
 #define LUA_AUTHORS 	&quot;R. Ierusalimschy, L. H. de Figueiredo &amp; W. Celes&quot;

Modified: trunk/src/lualong/luac.c
===================================================================
--- trunk/src/lualong/luac.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/luac.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: luac.c,v 1.1.1.1 2008/07/11 13:12:03 bogdanm Exp $
+** $Id: luac.c,v 1.54 2006/06/02 17:37:11 lhf Exp $
 ** Lua compiler (saves bytecodes to files; also list bytecodes)
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/luaconf.h
===================================================================
--- trunk/src/lualong/luaconf.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/luaconf.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: luaconf.h,v 1.1.1.1 2008/07/11 13:12:07 bogdanm Exp $
+** $Id: luaconf.h,v 1.82.1.7 2008/02/11 16:25:08 roberto Exp $
 ** Configuration file for Lua
 ** See Copyright Notice in lua.h
 */
@@ -11,8 +11,6 @@
 #include &lt;limits.h&gt;
 #include &lt;stddef.h&gt;
 
-#include &quot;type.h&quot;
-
 /*
 ** ==================================================================
 ** Search for &quot;@@&quot; to find all configurable definitions.
@@ -143,7 +141,11 @@
 */
 
 /* Changed to long for use with integral Lua numbers. */
+#if !defined LUA_NUMBER_INTEGRAL
+#define LUA_INTEGER ptrdiff_t
+#else
 #define LUA_INTEGER	long
+#endif
 
 /*
 @@ LUA_API is a mark for all core API functions.
@@ -261,7 +263,7 @@
 @* stand-alone interpreter.
 ** CHANGE it if you need longer lines.
 */
-#define LUA_MAXINPUT	512
+#define LUA_MAXINPUT	256
 
 
 /*
@@ -442,10 +444,10 @@
 @* can use.
 ** CHANGE it if you need lots of (Lua) stack space for your C
 ** functions. This limit is arbitrary; its only purpose is to stop C
-** functions to consume unlimited stack space.
+** functions to consume unlimited stack space. (must be smaller than
+** -LUA_REGISTRYINDEX)
 */
-#define LUAI_MCS_AUX	((int)(INT_MAX / (4*sizeof(LUA_NUMBER))))
-#define LUAI_MAXCSTACK	(LUAI_MCS_AUX &gt; SHRT_MAX ? SHRT_MAX : LUAI_MCS_AUX)
+#define LUAI_MAXCSTACK	8000
 
 
 
@@ -515,7 +517,6 @@
    no longer handles the floating point directives %e, %E, %f, %g, and
    %G. */
 
-#define LUA_NUMBER_INTEGRAL
 #if defined LUA_NUMBER_INTEGRAL
 #define LUA_NUMBER	long
 #else

Modified: trunk/src/lualong/lualib.h
===================================================================
--- trunk/src/lualong/lualib.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lualib.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lualib.h,v 1.1.1.1 2008/07/11 13:12:05 bogdanm Exp $
+** $Id: lualib.h,v 1.36.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua standard libraries
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lundump.c
===================================================================
--- trunk/src/lualong/lundump.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lundump.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lundump.c,v 1.1.1.1 2008/07/11 13:12:07 bogdanm Exp $
+** $Id: lundump.c,v 2.7.1.4 2008/04/04 19:51:41 roberto Exp $
 ** load precompiled Lua chunks
 ** See Copyright Notice in lua.h
 */
@@ -48,7 +48,6 @@
 static void LoadBlock(LoadState* S, void* b, size_t size)
 {
  size_t r=luaZ_read(S-&gt;Z,b,size);
- UNUSED(r);
  IF (r!=0, &quot;unexpected end&quot;);
 }
 
@@ -115,7 +114,7 @@
    	setnilvalue(o);
 	break;
    case LUA_TBOOLEAN:
-   	setbvalue(o,LoadChar(S));
+   	setbvalue(o,LoadChar(S)!=0);
 	break;
    case LUA_TNUMBER:
 	setnvalue(o,LoadNumber(S));
@@ -161,7 +160,9 @@
 
 static Proto* LoadFunction(LoadState* S, TString* p)
 {
- Proto* f=luaF_newproto(S-&gt;L);
+ Proto* f;
+ if (++S-&gt;L-&gt;nCcalls &gt; LUAI_MAXCCALLS) error(S,&quot;code too deep&quot;);
+ f=luaF_newproto(S-&gt;L);
  setptvalue2s(S-&gt;L,S-&gt;L-&gt;top,f); incr_top(S-&gt;L);
  f-&gt;source=LoadString(S); if (f-&gt;source==NULL) f-&gt;source=p;
  f-&gt;linedefined=LoadInt(S);
@@ -175,6 +176,7 @@
  LoadDebug(S,f);
  IF (!luaG_checkcode(f), &quot;bad code&quot;);
  S-&gt;L-&gt;top--;
+ S-&gt;L-&gt;nCcalls--;
  return f;
 }
 

Modified: trunk/src/lualong/lundump.h
===================================================================
--- trunk/src/lualong/lundump.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lundump.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lundump.h,v 1.1.1.1 2008/07/11 13:12:04 bogdanm Exp $
+** $Id: lundump.h,v 1.37.1.1 2007/12/27 13:02:25 roberto Exp $
 ** load precompiled Lua chunks
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lvm.c
===================================================================
--- trunk/src/lualong/lvm.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lvm.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lvm.c,v 1.1.1.1 2008/07/11 13:11:58 bogdanm Exp $
+** $Id: lvm.c,v 2.63.1.3 2007/12/28 15:32:23 roberto Exp $
 ** Lua virtual machine
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lvm.h
===================================================================
--- trunk/src/lualong/lvm.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lvm.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lvm.h,v 1.1.1.1 2008/07/11 13:12:05 bogdanm Exp $
+** $Id: lvm.h,v 2.5.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Lua virtual machine
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lzio.c
===================================================================
--- trunk/src/lualong/lzio.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lzio.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lzio.c,v 1.1.1.1 2008/07/11 13:11:59 bogdanm Exp $
+** $Id: lzio.c,v 1.31.1.1 2007/12/27 13:02:25 roberto Exp $
 ** a generic input stream interface
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/lzio.h
===================================================================
--- trunk/src/lualong/lzio.h	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/lzio.h	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: lzio.h,v 1.1.1.1 2008/07/11 13:12:06 bogdanm Exp $
+** $Id: lzio.h,v 1.21.1.1 2007/12/27 13:02:25 roberto Exp $
 ** Buffered streams
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/lualong/print.c
===================================================================
--- trunk/src/lualong/print.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/lualong/print.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -1,5 +1,5 @@
 /*
-** $Id: print.c,v 1.1.1.1 2008/07/11 13:11:55 bogdanm Exp $
+** $Id: print.c,v 1.55a 2006/05/31 13:30:05 lhf Exp $
 ** print bytecodes
 ** See Copyright Notice in lua.h
 */

Modified: trunk/src/main.c
===================================================================
--- trunk/src/main.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/main.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -185,6 +185,8 @@
     lua_main( 2, lua_argv );    
   }
   
+  printf( &quot;%d\n&quot;, sizeof( ptrdiff_t ) );
+  
   // Run the shell
   if( shell_init( XMODEM_MAX_FILE_SIZE ) == 0 )
   {

Modified: trunk/src/newlib/stubs.c
===================================================================
--- trunk/src/newlib/stubs.c	2008-09-02 17:44:40 UTC (rev 79)
+++ trunk/src/newlib/stubs.c	2008-09-10 17:57:24 UTC (rev 80)
@@ -319,8 +319,8 @@
 }
 #endif
 
-// If LUA_INTONLY is defined, &quot;redirect&quot; printf/scanf calls to their integer counterparts
-#ifdef LUA_INTONLY
+// If LUA_NUMBER_INTEGRAL is defined, &quot;redirect&quot; printf/scanf calls to their integer counterparts
+#ifdef LUA_NUMBER_INTEGRAL
 int _vfprintf_r( struct _reent *r, FILE *stream, const char *format, va_list ap )
 {
   return _vfiprintf_r( r, stream, format, ap );
@@ -331,7 +331,7 @@
 {
   return __svfiscanf_r( r, stream, format, ap );
 }
-#endif // #ifdef LUA_INTONLY
+#endif // #ifdef LUA_NUMBER_INTEGRAL
 
 #ifdef USE_MULTIPLE_ALLOCATOR
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000035.html">[Elua-svn] r79 - tags
</A></li>
	<LI>Next message: <A HREF="000037.html">[Elua-svn] r81 - trunk/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36">[ date ]</a>
              <a href="thread.html#36">[ thread ]</a>
              <a href="subject.html#36">[ subject ]</a>
              <a href="author.html#36">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/elua-svn">More information about the eLua-svn
mailing list</a><br>
</body></html>
