<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Elua-svn] r653 - in branches/pre0.7: inc inc/serial src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/elua-svn/2010-January/index.html" >
   <LINK REL="made" HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r653%20-%20in%20branches/pre0.7%3A%20inc%20inc/serial%20src&In-Reply-To=%3C201001150211.o0F2BBJK027648%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000608.html">
   <LINK REL="Next"  HREF="000610.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Elua-svn] r653 - in branches/pre0.7: inc inc/serial src</H1>
    <B>jbsnyder at BerliOS</B> 
    <A HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r653%20-%20in%20branches/pre0.7%3A%20inc%20inc/serial%20src&In-Reply-To=%3C201001150211.o0F2BBJK027648%40sheep.berlios.de%3E"
       TITLE="[Elua-svn] r653 - in branches/pre0.7: inc inc/serial src">jbsnyder at mail.berlios.de
       </A><BR>
    <I>Fri Jan 15 03:11:11 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000608.html">[Elua-svn] r652 - in branches/pre0.7: . inc src
</A></li>
        <LI>Next message: <A HREF="000610.html">[Elua-svn] r654 - branches/pre0.7/doc/en
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#609">[ date ]</a>
              <a href="thread.html#609">[ thread ]</a>
              <a href="subject.html#609">[ subject ]</a>
              <a href="author.html#609">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jbsnyder
Date: 2010-01-15 03:11:10 +0100 (Fri, 15 Jan 2010)
New Revision: 653

Modified:
   branches/pre0.7/inc/luarpc_rpc.h
   branches/pre0.7/inc/serial/serial.h
   branches/pre0.7/src/luarpc_desktop_serial.c
Log:
More LuaRPC tidying.

Modified: branches/pre0.7/inc/luarpc_rpc.h
===================================================================
--- branches/pre0.7/inc/luarpc_rpc.h	2010-01-15 02:10:51 UTC (rev 652)
+++ branches/pre0.7/inc/luarpc_rpc.h	2010-01-15 02:11:10 UTC (rev 653)
@@ -60,18 +60,17 @@
 #define MYASSERT(a) ;
 #endif
 
-/****************************************************************************/
-/* more error handling */
+//****************************************************************************
+// more error handling
 
-/* error numbers passed around are normal system &quot;errno&quot; error numbers
- * (normally generated by transport operations), except when they have the
- * following values:
- */
+// error numbers passed around are normal system &quot;errno&quot; error numbers
+//  (normally generated by transport operations), except when they have the
+//  following values:
 
 enum {
-  ERR_EOF       = MAXINT - 100,  /* reached end of file on transport */
-  ERR_CLOSED    = MAXINT - 101,  /* attempted operation on closed transport */
-  ERR_PROTOCOL  = MAXINT - 102,  /* some error in the received protocol */
+  ERR_EOF       = MAXINT - 100,  // reached end of file on transport
+  ERR_CLOSED    = MAXINT - 101,  // attempted operation on closed transport
+  ERR_PROTOCOL  = MAXINT - 102,  // some error in the received protocol
   ERR_NODATA    = MAXINT - 103,
   ERR_COMMAND   = MAXINT - 106,
   ERR_HEADER    = MAXINT - 107,
@@ -97,17 +96,13 @@
 typedef struct _Transport Transport;
 struct _Transport 
 {
-#ifdef WIN32_BUILD
-  HANDLE fd;
-#else
-  int fd;      /* INVALID_TRANSPORT if socket is closed */
-#endif
+  ser_handler fd;
   unsigned tmr_id;
-  u8     loc_little: 1, // Local is little endian?
-         loc_armflt: 1, // local float representation is arm float?
-         loc_intnum: 1, // Local is integer only?
-         net_little: 1, // Network is little endian?
-         net_intnum: 1; // Network is integer only?
+  u8     loc_little: 1,               // Local is little endian?
+         loc_armflt: 1,               // local float representation is arm float?
+         loc_intnum: 1,               // Local is integer only?
+         net_little: 1,               // Network is little endian?
+         net_intnum: 1;               // Network is integer only?
   u8     lnum_bytes;
 };
 
@@ -116,26 +111,26 @@
 typedef struct _Handle Handle;
 struct _Handle 
 {
-  Transport tpt;      /* the handle socket */
-  int error_handler;    /* function reference */
-  int async;      /* nonzero if async mode being used */
-  int read_reply_count;   /* number of async call return values to read */  
+  Transport tpt;                      // the handle socket
+  int error_handler;                  // function reference
+  int async;                          // nonzero if async mode being used
+  int read_reply_count;               // number of async call return values to read
 };
 
 
 typedef struct _Helper Helper;
 struct _Helper {
-  Handle *handle;     /* pointer to handle object */
-	Helper *parent; /* parent helper */
-	u8 nparents; /* number of parents */
-  char funcname[NUM_FUNCNAME_CHARS];  /* name of the function */
+  Handle *handle;                     // pointer to handle object
+	Helper *parent;                     // parent helper
+	u8 nparents;                        // number of parents
+  char funcname[NUM_FUNCNAME_CHARS];  // name of the function
 };
 
 
 typedef struct _ServerHandle ServerHandle;
 struct _ServerHandle {
-  Transport ltpt;   /* listening socket, always valid if no error */
-  Transport atpt;   /* accepting socket, valid if connection established */
+  Transport ltpt;   // listening transport, always valid if no error
+  Transport atpt;   // accepting transport, valid if connection established
 	int link_errs;
 };
 
@@ -155,36 +150,36 @@
 		Throw( e ); \
 	}
 
-/* Arg &amp; Error Checking Provided to Transport Mechanisms */
+// Arg &amp; Error Checking Provided to Transport Mechanisms 
 int check_num_args (lua_State *L, int desired_n);
 void deal_with_error (lua_State *L, Handle *h, const char *error_string);
 void my_lua_error( lua_State *L, const char *errmsg );
 
-/* TRANSPORT API */
+// TRANSPORT API 
 
-/* Setup Transport */
+// Setup Transport 
 void transport_init (Transport *tpt);
 
-/* Open Listener / Server */
+// Open Listener / Server 
 void transport_open_listener(lua_State *L, ServerHandle *handle);
 
-/* Open Connection / Client */
+// Open Connection / Client 
 int transport_open_connection(lua_State *L, Handle *handle);
 
-/* Accept Connection */
+// Accept Connection 
 void transport_accept (Transport *tpt, Transport *atpt);
 
-/* Read &amp; Write to Transport */
+// Read &amp; Write to Transport 
 void transport_read_buffer (Transport *tpt, u8 *buffer, int length);
 void transport_write_buffer (Transport *tpt, const u8 *buffer, int length);
 
-/* Check if data is available on connection without reading:
- 		- 1 = data available, 0 = no data available */
+// Check if data is available on connection without reading:
+// 		- 1 = data available, 0 = no data available
 int transport_readable (Transport *tpt);
 
-/* Check if transport is open:
-		- 1 = connection open, 0 = connection closed */
+// Check if transport is open:
+//		- 1 = connection open, 0 = connection closed
 int transport_is_open (Transport *tpt);
 
-/* Shut down connection */
+// Shut down connection
 void transport_close (Transport *tpt);

Modified: branches/pre0.7/inc/serial/serial.h
===================================================================
--- branches/pre0.7/inc/serial/serial.h	2010-01-15 02:10:51 UTC (rev 652)
+++ branches/pre0.7/inc/serial/serial.h	2010-01-15 02:11:10 UTC (rev 653)
@@ -43,5 +43,6 @@
 u32 ser_write( ser_handler id, const u8 *src, u32 size );
 u32 ser_write_byte( ser_handler id, u8 data );
 void ser_set_timeout_ms( ser_handler id, u32 timeout );
+int ser_readable( ser_handler id );
 
 #endif

Modified: branches/pre0.7/src/luarpc_desktop_serial.c
===================================================================
--- branches/pre0.7/src/luarpc_desktop_serial.c	2010-01-15 02:10:51 UTC (rev 652)
+++ branches/pre0.7/src/luarpc_desktop_serial.c	2010-01-15 02:11:10 UTC (rev 653)
@@ -9,7 +9,6 @@
 #include &lt;alloca.h&gt;
 #endif
 
-
 #include &quot;lua.h&quot;
 #include &quot;lualib.h&quot;
 #include &quot;lauxlib.h&quot;
@@ -19,10 +18,9 @@
 
 void transport_open( Transport *tpt, const char *path );
 
-
 #ifdef LUARPC_ENABLE_SERIAL
 
-/* Setup Transport */
+// Setup Transport 
 void transport_init (Transport *tpt)
 {
   tpt-&gt;fd = INVALID_TRANSPORT;
@@ -46,10 +44,10 @@
   ser_set_timeout_ms( tpt-&gt;fd, 1000 );
 }
 
-/* Open Listener / Server */
+// Open Listener / Server 
 void transport_open_listener(lua_State *L, ServerHandle *handle)
 {
-  check_num_args (L,2); /* 1st arg is path, 2nd is handle */
+  check_num_args (L,2); // 1st arg is path, 2nd is handle
   if (!lua_isstring (L,1))
     luaL_error(L,&quot;first argument must be serial serial port&quot;);
 
@@ -58,10 +56,10 @@
   while( transport_readable( &amp;handle-&gt;ltpt ) == 0 ); // wait for incoming data
 }
 
-/* Open Connection / Client */
+// Open Connection / Client
 int transport_open_connection(lua_State *L, Handle *handle)
 { 
-  check_num_args (L,2); /* 1st arg is path, 2nd is handle */
+  check_num_args (L,2); // 1st arg is path, 2nd is handle
   if (!lua_isstring (L,1))
     luaL_error(L,&quot;first argument must be serial serial port&quot;);
 
@@ -70,7 +68,7 @@
   return 1;
 }
 
-/* Accept Connection */
+// Accept Connection
 void transport_accept (Transport *tpt, Transport *atpt)
 {
   struct exception e;
@@ -81,7 +79,7 @@
 }
 
 
-/* Read &amp; Write to Transport */
+// Read &amp; Write to Transport
 void transport_read_buffer (Transport *tpt, u8 *buffer, int length)
 {
   u32 n;
@@ -94,7 +92,7 @@
 
     n = ser_read( tpt-&gt;fd, buffer, length );
     
-    /* error handling */
+    // error handling
     if( n == 0 )
     {
       e.errnum = ERR_NODATA;
@@ -130,8 +128,8 @@
   }
 }
 
-/* Check if data is available on connection without reading:
-    - 1 = data available, 0 = no data available */
+// Check if data is available on connection without reading:
+//    - 1 = data available, 0 = no data available
 int transport_readable (Transport *tpt)
 {
   struct exception e;
@@ -152,26 +150,21 @@
   return ( ret &gt; 0 );
 }
 
-/* Check if transport is open:
-    1 = connection open, 0 = connection closed */
+// Check if transport is open:
+//    1 = connection open, 0 = connection closed
 int transport_is_open (Transport *tpt)
 {
   return (tpt-&gt;fd != INVALID_TRANSPORT);
 }
 
-/* Shut down connection */
+// Shut down connection
 void transport_close (Transport *tpt)
 {
   if (tpt-&gt;fd != INVALID_TRANSPORT)
   {
-    /* close (tpt-&gt;fd); -- not closing for now since atpt and ltpt use same fd,
-                           should use some method to detect whether one has 
-                           already dropped, and properly close out on exit */
-    
-    /* Send break to the other side to indicate to opposing side that connection is ending */
     ser_close( tpt-&gt;fd );
     tpt-&gt;fd = INVALID_TRANSPORT;
   }
 }
 
-#endif /* LUARPC_ENABLE_SERIAL */
+#endif // LUARPC_ENABLE_SERIAL


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000608.html">[Elua-svn] r652 - in branches/pre0.7: . inc src
</A></li>
	<LI>Next message: <A HREF="000610.html">[Elua-svn] r654 - branches/pre0.7/doc/en
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#609">[ date ]</a>
              <a href="thread.html#609">[ thread ]</a>
              <a href="subject.html#609">[ subject ]</a>
              <a href="author.html#609">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/elua-svn">More information about the eLua-svn
mailing list</a><br>
</body></html>
