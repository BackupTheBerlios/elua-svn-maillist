<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Elua-svn] r111 - in trunk: romfs src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/elua-svn/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r111%20-%20in%20trunk%3A%20romfs%20src&In-Reply-To=%3C200810271920.m9RJKlWt014107%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000066.html">
   <LINK REL="Next"  HREF="000068.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Elua-svn] r111 - in trunk: romfs src</H1>
    <B>bogdanm at BerliOS</B> 
    <A HREF="mailto:elua-svn%40lists.berlios.de?Subject=Re%3A%20%5BElua-svn%5D%20r111%20-%20in%20trunk%3A%20romfs%20src&In-Reply-To=%3C200810271920.m9RJKlWt014107%40sheep.berlios.de%3E"
       TITLE="[Elua-svn] r111 - in trunk: romfs src">bogdanm at mail.berlios.de
       </A><BR>
    <I>Mon Oct 27 20:20:47 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000066.html">[Elua-svn] r110 - trunk/src
</A></li>
        <LI>Next message: <A HREF="000068.html">[Elua-svn] r112 - in trunk: . docs inc romfs src src/lua	src/modules src/newlib src/platform/lm3s
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#67">[ date ]</a>
              <a href="thread.html#67">[ thread ]</a>
              <a href="subject.html#67">[ subject ]</a>
              <a href="author.html#67">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: bogdanm
Date: 2008-10-27 20:20:23 +0100 (Mon, 27 Oct 2008)
New Revision: 111

Added:
   trunk/romfs/index.pht
   trunk/romfs/lhttpd.lua
   trunk/romfs/test.lua
Modified:
   trunk/src/elua_uip.c
Log:
- corrected the uIP support code in send mode
- added the eLua web server example (romfs/lhttpd.lua, romfs/index.pht, romfs/test.lua). Use &quot;lua /rom/lhttpd.lua&quot; from the console to run the server. The server code is largely WIP.



Added: trunk/romfs/index.pht
===================================================================
--- trunk/romfs/index.pht	2008-10-23 20:41:37 UTC (rev 110)
+++ trunk/romfs/index.pht	2008-10-27 19:20:23 UTC (rev 111)
@@ -0,0 +1,51 @@
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/strict.dtd">http://www.w3.org/TR/html4/strict.dtd</A>&quot;&gt;
+&lt;html&gt;&lt;head&gt;
+&lt;meta content=&quot;text/html; charset=ISO-8859-1&quot; http-equiv=&quot;content-type&quot;&gt;&lt;title&gt;eLua webserver test&lt;/title&gt;
+&lt;/head&gt;&lt;body&gt;
+&lt;div style=&quot;text-align: center;&quot;&gt;&lt;big&gt;Welcome to the &lt;span style=&quot;font-weight: bold;&quot;&gt;eLua&lt;/span&gt; web server!&lt;span style=&quot;font-weight: bold;&quot;&gt;&lt;/span&gt;&lt;/big&gt;&lt;br&gt; &lt;/div&gt;
+&lt;br&gt;
+&lt;div style=&quot;text-align: left;&quot;&gt;The right column of the following table is generated by embedded Lua code:&lt;br&gt;
+&lt;br&gt;
+&lt;table style=&quot;text-align: left; width: 400px;&quot; border=&quot;1&quot; cellpadding=&quot;2&quot; cellspacing=&quot;2&quot;&gt;
+&lt;tbody&gt;
+&lt;tr&gt;
+&lt;td&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;eLua CPU&lt;/span&gt;&lt;/td&gt;
+&lt;td&gt;&lt;?lua print(pd.cpu()) ?&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+&lt;td&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;eLua board&lt;/span&gt;&lt;/td&gt;
+&lt;td&gt;&lt;?lua print(pd.board()) ?&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/tbody&gt;
+&lt;/table&gt;
+&lt;br&gt;
+And now let's test CGI. Use the form below to control the on-board LED.&lt;br&gt;&lt;br&gt;
+&lt;form method=&quot;get&quot; action=&quot;<A HREF="http://elua/index.pht">http://elua/index.pht</A>&quot; name=&quot;led&quot;&gt;
+&lt;table style=&quot;text-align: left; width: 400px;&quot; border=&quot;0&quot; cellpadding=&quot;2&quot; cellspacing=&quot;2&quot;&gt;
+&lt;tbody&gt;
+&lt;tr&gt;
+&lt;td style=&quot;text-align: center;&quot; valign=&quot;undefined&quot;&gt;&lt;button value=&quot;ledon&quot; name=&quot;ledon&quot;&gt;Led ON&lt;/button&gt;&lt;/td&gt;
+&lt;td style=&quot;text-align: center;&quot; valign=&quot;undefined&quot;&gt;&lt;button value=&quot;ledoff&quot; name=&quot;ledoff&quot;&gt;Led OFF&lt;/button&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/tbody&gt;
+&lt;/table&gt;
+&lt;/form&gt;
+&lt;?lua
+  local ledpin = pio.PF_0
+  pio.output(ledpin)
+  if reqdata['ledon'] == 'ledon' then
+    pio.set(ledpin)
+    print '&lt;br&gt;&lt;font color=&quot;blue&quot;&gt;&lt;b&gt;The LED is now ON&lt;/b&gt;&lt;/font&gt;&lt;br&gt;'
+  elseif reqdata['ledoff'] == 'ledoff' then
+    pio.clear(ledpin)
+    print '&lt;br&gt;&lt;font color=&quot;blue&quot;&gt;&lt;b&gt;The LED is now OFF&lt;/b&gt;&lt;/font&gt;&lt;br&gt;'    
+  elseif next(reqdata) ~= nil then
+    print '&lt;br&gt;&lt;font color=&quot;red&quot;&gt;&lt;b&gt;Invalid CGI request!&lt;/b&gt;&lt;/font&gt;&lt;br&gt;'    
+  end
+?&gt;
+&lt;br&gt;
+Press &lt;a href=&quot;<A HREF="http://elua/test.lua">http://elua/test.lua</A>&quot;&gt;here&lt;/a&gt; to go to a test page generated completely by a Lua script.&lt;br&gt;
+&lt;br&gt;
+&lt;span style=&quot;font-weight: bold;&quot;&gt;AND MOST IMPORTANTLY ... remember to have fun with eLua :)&lt;/span&gt;&lt;br&gt;
+&lt;/div&gt;
+&lt;/body&gt;&lt;/html&gt;

Added: trunk/romfs/lhttpd.lua
===================================================================
--- trunk/romfs/lhttpd.lua	2008-10-23 20:41:37 UTC (rev 110)
+++ trunk/romfs/lhttpd.lua	2008-10-27 19:20:23 UTC (rev 111)
@@ -0,0 +1,116 @@
+-- Mapping between file extension (and request) and HTTP response
+local extmap = {
+  txt = &quot;text/plain&quot;,
+  htm = &quot;text/html&quot;,
+  pht = &quot;text/html&quot;,
+  gif = &quot;image/gif&quot;,
+  jpg = &quot;imge/jpeg&quot;,
+  png = &quot;image/png&quot;,
+  lua = &quot;text/html&quot;
+}
+
+local basedir = &quot;/rom/&quot;
+reqdata = {}
+
+-- Auxiliary function: execute the given code with a substituted &quot;print&quot;
+-- that prints everything to a string, return the code output
+local function docode(thecode)
+  local strbuf = {}
+  local oldprint, newprint =  print, function(...)
+    local total, idx = select('#', ...)
+    for idx = 1, total do
+      strbuf[#strbuf + 1] = tostring(select(idx, ...)) .. (idx == total and '\n' or '\t')
+    end
+  end
+  print = newprint
+  local f = loadstring(thecode)
+  if f then
+    f()
+  else
+    print &quot;&gt;&gt;&gt; Invalid Lua code &lt;&lt;&lt;&quot;
+  end
+  print = oldprint
+  collectgarbage('collect')
+  return table.concat(strbuf)
+end
+
+function process(header)
+    -- look for first line
+	local s, e = header:find(&quot;[^\n]+\n&quot;)
+	local reqstr = header:sub(s, e)
+  local respheader, respdata = '', ''
+  
+  reqdata = {}
+	-- check if the request is valid, also keep the actual request
+	local i, valid, req = 0, false
+	for w in reqstr:gmatch(&quot;%S+&quot;) do
+	  valid = ( i == 0 and w == &quot;GET&quot; ) or valid
+	  req = ( i == 1 and w ) or req
+	  i = i + 1
+	end
+
+    -- valid is true if the request is valid, req has the request string
+	if valid then
+    -- now look for all parameters in this request (if any)
+    local fname = &quot;&quot;
+    if req:find(&quot;%?&quot;) then
+      local rest
+      _, _, fname, rest = req:find(&quot;(.*)%?(.*)&quot;)
+      -- small trick: end &quot;rest&quot; with a &quot;&amp;&quot; for easier processing
+      -- now look for &quot;var=value&quot; pairs in the request (GET encoding)
+      rest = rest .. &quot;&amp;&quot;
+      for crtpair in rest:gmatch(&quot;[^&amp;]+&quot;) do
+        local _, __, k, v = crtpair:find(&quot;(.*)=(.*)&quot;)
+        -- replace all &quot;%xx&quot; characters with their actual value
+        v = v:gsub(&quot;(%%%x%x)&quot;, function(s) return string.char(tonumber(s:sub(2, -1), 16)) end)
+        reqdata[k] = v
+      end
+    else
+      fname = req
+    end
+    fname = ( fname == &quot;/&quot; ) and &quot;index.pht&quot; or fname:sub(2, -1)
+    s, e = fname:find(&quot;%.[%a%d]+$&quot;)
+    local ftype = fname:sub(s+1, e):lower()
+    ftype = (#ftype &gt; 0 and ftype) or &quot;txt&quot;
+    fname = basedir .. fname
+    
+    -- now &quot;fname&quot; has the name of the requested file, and &quot;reqdata&quot; the actual request data
+    -- also &quot;ftype&quot; holds the file type (actually its extension)
+    local tf = io.open(fname, &quot;r&quot;)
+    if tf then
+      respheader = &quot;HTTP/1.1 200 OK\r\nConnection: close\r\nServer: eLua-miniweb\r\nContent-Type: &quot; .. extmap[ftype or &quot;txt&quot;] .. &quot;\r\n\r\n&quot;
+      -- Preprocess &quot;lua&quot; and &quot;pht&quot; files: run the Lua ones, parse the .htm ones for &quot;&lt;?lua ... ?&gt;&quot; sequences
+      if ftype == &quot;pht&quot; or ftype == &quot;lua&quot; then
+        local fdata = tf:read(&quot;*a&quot;)
+        if ftype == &quot;lua&quot; then
+          respdata = docode(fdata)
+        else
+          -- Look for &lt;?lua ... lua&gt; patterns and execute them accordingly
+          respdata = fdata:gsub(&quot;&lt;%?lua(.-)%?&gt;&quot;, docode)
+        end
+      else
+        respdata = tf:read(&quot;*a&quot;)
+      end
+      tf:close()
+    else
+      respheader = &quot;HTTP/1.1 404 Not Found\r\nConnection: close\r\nServer: eLua-miniweb\r\nContent-Type: text/html\r\n\r\nPage not found&quot;
+    end
+  end
+  return respheader .. respdata
+end
+
+while true do
+  local sock, remoteip, err = net.accept( 80 )
+  print( &quot;Got connection on socket&quot;, sock )
+  print( &quot;Remote ip: &quot; .. net.unpackip( remoteip, &quot;*s&quot; ) )
+  local response, err2 = net.recv( sock, 1024 )
+  print &quot;Got request&quot;
+  local httpdata = process( response )
+  if #httpdata &gt; 0 then
+    print &quot;Sending response&quot;
+    net.send( sock, httpdata )
+  end
+  net.close( sock )
+  reqdata = {}
+  collectgarbage('collect')
+end

Added: trunk/romfs/test.lua
===================================================================
--- trunk/romfs/test.lua	2008-10-23 20:41:37 UTC (rev 110)
+++ trunk/romfs/test.lua	2008-10-27 19:20:23 UTC (rev 111)
@@ -0,0 +1,4 @@
+print &quot;&lt;html&gt;&lt;body&gt;&quot;
+print &quot;Hello from eLua!&lt;br&gt;&quot;
+print 'Press &lt;a href=&quot;<A HREF="http://elua/">http://elua/</A>&quot;&gt;here&lt;/a&gt; to return to the main page.'
+print &quot;&lt;/body&gt;&lt;/html&gt;&quot;

Modified: trunk/src/elua_uip.c
===================================================================
--- trunk/src/elua_uip.c	2008-10-23 20:41:37 UTC (rev 110)
+++ trunk/src/elua_uip.c	2008-10-27 19:20:23 UTC (rev 111)
@@ -342,17 +342,11 @@
     // We write directly in UIP's buffer 
     if( uip_acked() )
     {
-      // Send next part of the buffer (if needed)
-      if( s-&gt;len &lt;= uip_mss() ) // end of transmission
-      { 
-        s-&gt;len = 0;
+      elua_net_size minlen = UMIN( s-&gt;len, uip_mss() );    
+      s-&gt;len -= minlen;
+      s-&gt;ptr += minlen;
+      if( s-&gt;len == 0 )
         s-&gt;state = ELUA_UIP_STATE_IDLE;
-      }
-      else
-      {
-        s-&gt;len -= uip_conn-&gt;len;
-        s-&gt;ptr += uip_conn-&gt;len;
-      }
     }
     if( s-&gt;len &gt; 0 ) // need to (re)transmit?
     {
@@ -364,7 +358,7 @@
       }
       else
 #endif      
-        uip_send( s-&gt;ptr, s-&gt;len );
+        uip_send( s-&gt;ptr, UMIN( s-&gt;len, uip_mss() ) );
     }
     return;
   }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000066.html">[Elua-svn] r110 - trunk/src
</A></li>
	<LI>Next message: <A HREF="000068.html">[Elua-svn] r112 - in trunk: . docs inc romfs src src/lua	src/modules src/newlib src/platform/lm3s
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#67">[ date ]</a>
              <a href="thread.html#67">[ thread ]</a>
              <a href="subject.html#67">[ subject ]</a>
              <a href="author.html#67">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/elua-svn">More information about the eLua-svn
mailing list</a><br>
</body></html>
